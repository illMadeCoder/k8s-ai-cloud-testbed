---
# GCP Composition for GKECluster XRD
# Creates: VPC Network, Subnetwork, GKE Cluster, Node Pool
# Outputs kubeconfig for ArgoCD cluster registration
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xgkeclusters.gcp.illm.io
  labels:
    provider: gcp
    crossplane.io/xrd: xgkeclusters.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XGKECluster

  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          # VPC Network
          - name: vpc-network
            base:
              apiVersion: compute.gcp.upbound.io/v1beta1
              kind: Network
              spec:
                forProvider:
                  autoCreateSubnetworks: false
                  routingMode: REGIONAL
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-network"
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-network"

          # Subnetwork for nodes
          - name: subnet
            base:
              apiVersion: compute.gcp.upbound.io/v1beta1
              kind: Subnetwork
              spec:
                forProvider:
                  ipCidrRange: "10.0.0.0/20"
                  networkSelector:
                    matchControllerRef: true
                  privateIpGoogleAccess: true
                  # Secondary ranges for pods and services (VPC-native)
                  secondaryIpRange:
                    - ipCidrRange: "10.1.0.0/16"
                      rangeName: pods
                    - ipCidrRange: "10.2.0.0/20"
                      rangeName: services
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-subnet"
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-subnet"
              # Extract region from zone (e.g., us-central1-a -> us-central1)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.zone
                toFieldPath: spec.forProvider.region
                transforms:
                  - type: string
                    string:
                      type: Regexp
                      regexp:
                        match: '^(.+)-[a-z]$'
                        group: 1

          # GKE Cluster (control plane)
          - name: gke-cluster
            base:
              apiVersion: container.gcp.upbound.io/v1beta2
              kind: Cluster
              spec:
                forProvider:
                  # Keep default pool (1 × e2-medium) — removing it races with
                  # custom nodepool creation in Crossplane async mode, causing
                  # INVALID_STATE_FOR_UPDATE errors (P1 bug illm-k8s-ai-lab-ku4)
                  initialNodeCount: 1
                  # VPC-native cluster (uses alias IPs)
                  networkingMode: VPC_NATIVE
                  networkSelector:
                    matchControllerRef: true
                  subnetworkSelector:
                    matchControllerRef: true
                  ipAllocationPolicy:
                    clusterSecondaryRangeName: pods
                    servicesSecondaryRangeName: services
                  # Enable client certificate auth for programmatic access
                  masterAuth:
                    clientCertificateConfig:
                      issueClientCertificate: true
                  # Lab cluster settings
                  deletionProtection: false  # Allow easy cleanup
                  loggingService: none       # Use own observability stack
                  monitoringService: none
                  releaseChannel:
                    channel: REGULAR
                writeConnectionSecretToRef:
                  namespace: crossplane-system
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "illm-%s"
              # Use zone for zonal cluster (cheaper than regional)
              - type: FromCompositeFieldPath
                fromFieldPath: spec.zone
                toFieldPath: spec.forProvider.location
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: spec.writeConnectionSecretToRef.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-cluster-conn"
              # Status outputs
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.endpoint
                toFieldPath: status.endpoint
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.status
                toFieldPath: status.status
              - type: ToCompositeFieldPath
                fromFieldPath: metadata.annotations[crossplane.io/external-name]
                toFieldPath: status.clusterName

          # Node Pool (worker nodes)
          - name: node-pool
            base:
              apiVersion: container.gcp.upbound.io/v1beta2
              kind: NodePool
              spec:
                forProvider:
                  clusterSelector:
                    matchControllerRef: true
                  nodeConfig:
                    oauthScopes:
                      - https://www.googleapis.com/auth/cloud-platform
                    # Secure defaults
                    shieldedInstanceConfig:
                      enableIntegrityMonitoring: true
                      enableSecureBoot: true
                  management:
                    autoRepair: true
                    autoUpgrade: true
                  upgradeSettings:
                    maxSurge: 1
                    maxUnavailable: 0
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-nodes"
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-nodes"
              - type: FromCompositeFieldPath
                fromFieldPath: spec.nodeCount
                toFieldPath: spec.forProvider.nodeCount
              - type: FromCompositeFieldPath
                fromFieldPath: spec.machineType
                toFieldPath: spec.forProvider.nodeConfig.machineType
              - type: FromCompositeFieldPath
                fromFieldPath: spec.diskSizeGb
                toFieldPath: spec.forProvider.nodeConfig.diskSizeGb
              - type: FromCompositeFieldPath
                fromFieldPath: spec.preemptible
                toFieldPath: spec.forProvider.nodeConfig.preemptible

    - step: auto-ready
      functionRef:
        name: function-auto-ready
