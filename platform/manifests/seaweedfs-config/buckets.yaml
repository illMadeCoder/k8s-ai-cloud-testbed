# S3 Buckets for Observability Stack
# Creates buckets in SeaweedFS for Loki, Mimir, and Tempo
#
# Reliability improvements:
# - Runs as regular resource (not hook) with sync-wave after SeaweedFS
# - Excludes Istio sidecar to avoid proxy startup race conditions
# - High backoff limit with extended timeout for S3 readiness
# - Uses curl for S3 ops (lighter than aws-cli, more reliable)

apiVersion: batch/v1
kind: Job
metadata:
  name: seaweedfs-create-buckets
  namespace: seaweedfs
  annotations:
    argocd.argoproj.io/sync-wave: "5"  # After SeaweedFS (wave 4)
spec:
  backoffLimit: 10
  activeDeadlineSeconds: 600  # 10 minute total timeout
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        sidecar.istio.io/inject: "false"  # Avoid sidecar race conditions
    spec:
      restartPolicy: OnFailure
      # Pod security context for Talos PSS compliance
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: create-buckets
          image: curlimages/curl:8.5.0
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
          command:
            - /bin/sh
            - -c
            - |
              set -e
              S3_ENDPOINT="http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333"

              echo "Waiting for SeaweedFS S3 endpoint..."
              RETRIES=0
              MAX_RETRIES=60
              until curl -sf "$S3_ENDPOINT/" >/dev/null 2>&1; do
                RETRIES=$((RETRIES + 1))
                if [ $RETRIES -ge $MAX_RETRIES ]; then
                  echo "ERROR: S3 not ready after $MAX_RETRIES attempts"
                  exit 1
                fi
                echo "Waiting for S3... (attempt $RETRIES/$MAX_RETRIES)"
                sleep 5
              done

              echo "S3 endpoint ready. Creating buckets..."

              # Create buckets using S3 PUT requests
              for bucket in loki-chunks loki-ruler tempo-traces mimir-blocks mimir-ruler mimir-alertmanager; do
                echo "Creating bucket: $bucket"
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT "$S3_ENDPOINT/$bucket")
                if [ "$HTTP_CODE" = "200" ]; then
                  echo "  ✓ Created $bucket"
                elif [ "$HTTP_CODE" = "409" ]; then
                  echo "  ✓ $bucket already exists"
                else
                  echo "  ✗ Failed to create $bucket (HTTP $HTTP_CODE)"
                  # Don't fail - bucket might exist with different response code
                fi
              done

              echo ""
              echo "Verifying buckets:"
              curl -s "$S3_ENDPOINT/" | grep -o '<Name>[^<]*</Name>' | sed 's/<[^>]*>//g' | while read b; do
                echo "  - $b"
              done

              echo ""
              echo "Done!"
