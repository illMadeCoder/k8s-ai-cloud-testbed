# ArgoCD values for Talos hub (GitOps-managed)
#
# This is the ongoing config - changes here are synced by ArgoCD.
# The bootstrap values file is only used for initial install.
#
# External access is via Tailscale ingress.
# kube-vip LoadBalancer IPs available when kube-vip is deployed:
#   DNS=.240, ArgoCD=.241, OpenBao=.242

server:
  podLabels:
    app.kubernetes.io/instance: argocd
  service:
    type: ClusterIP

  # TLS disabled - Tailscale provides encryption for external access
  # Internal LAN access doesn't require TLS
  certificate:
    enabled: false
  # Run in insecure mode (no TLS) - traffic is encrypted by Tailscale
  extraArgs:
    - --insecure

# Webhook Configuration
# For local development, webhook secret is optional (smee.io URL is obscure enough)
# To enable: configure same secret in GitHub webhook settings and uncomment below
# configs:
#   secret:
#     githubSecret: "your-shared-secret"

# Fix: Add instance label to all components (required by service selectors)
# See: illm-k8s-ai-lab-vek
controller:
  podLabels:
    app.kubernetes.io/instance: argocd

repoServer:
  podLabels:
    app.kubernetes.io/instance: argocd

applicationSet:
  podLabels:
    app.kubernetes.io/instance: argocd

notifications:
  podLabels:
    app.kubernetes.io/instance: argocd

redis:
  podLabels:
    app.kubernetes.io/instance: argocd

dex:
  podLabels:
    app.kubernetes.io/instance: argocd

# Custom resource health checks
# Fix: CRD-only Crossplane providers (replicas: 0) show as unhealthy because
# there are no pods. This blocks ArgoCD sync waves. We consider a Provider
# healthy when its "Installed" condition is True (CRDs are registered).
configs:
  cm:
    # Fix: K8s 1.35 added .status.terminatingReplicas to Deployments, ReplicaSets,
    # and StatefulSets. ArgoCD's structured merge diff doesn't have this field in
    # its schema, causing all apps with these resources to show sync status "Unknown"
    # with ComparisonError. Ignore this field globally.
    # TODO: Remove after upgrading ArgoCD to a version with K8s 1.35 schema support.
    resource.customizations.ignoreDifferences.apps_Deployment: |
      jsonPointers:
        - /status/terminatingReplicas
    resource.customizations.ignoreDifferences.apps_ReplicaSet: |
      jsonPointers:
        - /status/terminatingReplicas
    resource.customizations.ignoreDifferences.apps_StatefulSet: |
      jsonPointers:
        - /status/terminatingReplicas

    resource.customizations.health.pkg.crossplane.io_Provider: |
      hs = {}
      if obj.status ~= nil and obj.status.conditions ~= nil then
        for i, condition in ipairs(obj.status.conditions) do
          if condition.type == "Installed" then
            if condition.status == "True" then
              hs.status = "Healthy"
              hs.message = "Provider CRDs installed"
              return hs
            else
              hs.status = "Progressing"
              hs.message = condition.message or "Installing CRDs"
              return hs
            end
          end
        end
      end
      hs.status = "Progressing"
      hs.message = "Waiting for provider status"
      return hs
