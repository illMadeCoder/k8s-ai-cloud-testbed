---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: backstage
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    - repoURL: https://backstage.github.io/charts
      chart: backstage
      targetRevision: 2.6.3
      helm:
        releaseName: backstage
        values: |
          backstage:
            image:
              registry: ghcr.io
              repository: backstage/backstage
              tag: latest
            startupProbe:
              httpGet:
                path: /.backstage/health/v1/liveness
                port: 7007
                scheme: HTTP
              initialDelaySeconds: 30
              periodSeconds: 10
              failureThreshold: 30
              timeoutSeconds: 5
            extraVolumes:
              - name: catalog
                configMap:
                  name: backstage-catalog
            extraVolumeMounts:
              - name: catalog
                mountPath: /etc/backstage
            extraEnvVars:
              - name: APP_CONFIG_app_baseUrl
                value: "http://backstage.local:32266"
              - name: APP_CONFIG_backend_baseUrl
                value: "http://backstage.local:32266"
            appConfig:
              app:
                title: "K8s Lab Backstage"
                baseUrl: http://backstage.local:32266
              organization:
                name: "K8s Lab"
              backend:
                baseUrl: http://backstage.local:32266
                listen:
                  port: 7007
                reading:
                  allow:
                    - host: raw.githubusercontent.com
                csp:
                  upgrade-insecure-requests: false
                  connect-src: ["'self'", "http:", "https:"]
                  default-src: ["'self'"]
                  script-src: ["'self'", "'unsafe-eval'"]
                  style-src: ["'self'", "'unsafe-inline'"]
                  img-src: ["'self'", "data:"]
                  font-src: ["'self'"]
                  frame-ancestors: ["'self'"]
                  object-src: ["'none'"]
                cors:
                  origin:
                    - http://backstage.local:32266
                    - http://localhost:7007
                  methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
                  credentials: true
                database:
                  client: better-sqlite3
                  connection: ":memory:"
              techdocs:
                builder: local
                generator:
                  runIn: local
                publisher:
                  type: local
              catalog:
                import:
                  entityFilename: catalog-info.yaml
                rules:
                  - allow: [Component, System, API, Resource, Location, Template, User, Group]
                locations:
                  - type: file
                    target: /etc/backstage/catalog.yaml
                    rules:
                      - allow: [System, Component, API, Resource, Location, Template, User, Group]
              auth:
                environment: development
                providers:
                  guest: {}
              permission:
                enabled: false
          service:
            type: NodePort
          postgresql:
            enabled: false
    - repoURL: https://github.com/illMadeCoder/illm-k8s-lab.git
      targetRevision: HEAD
      ref: values
    - repoURL: https://github.com/illMadeCoder/illm-k8s-lab.git
      targetRevision: HEAD
      path: manifests/backstage
      directory:
        include: '*-httproute.yaml'
  destination:
    server: https://kubernetes.default.svc
    namespace: backstage
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
