---
# AWS Composition for Cache XRD
# Creates AWS ElastiCache Redis/Memcached Cluster
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xcaches.aws.illm.io
  labels:
    provider: aws
    crossplane.io/xrd: xcaches.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XCache

  environment:
    environmentConfigs:
      - type: Reference
        ref:
          name: cluster-info

  resources:
    # Subnet Group
    - name: subnet-group
      base:
        apiVersion: elasticache.aws.upbound.io/v1beta1
        kind: SubnetGroup
        spec:
          forProvider:
            region: us-east-1
            description: "Crossplane managed subnet group for cache"
            subnetIdSelector:
              matchLabels:
                access: private
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cache-subnet"

    # Security Group
    - name: security-group
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroup
        spec:
          forProvider:
            region: us-east-1
            description: "Security group for ElastiCache"
            vpcIdSelector:
              matchLabels:
                type: main
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cache-sg"

    # Security Group Rule - Redis
    - name: sg-rule-redis
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        spec:
          forProvider:
            region: us-east-1
            type: ingress
            fromPort: 6379
            toPort: 6379
            protocol: tcp
            cidrBlocks:
              - "10.0.0.0/8"
            securityGroupIdSelector:
              matchControllerRef: true
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cache-sg-rule"

    # ElastiCache Replication Group (Redis)
    - name: elasticache-redis
      base:
        apiVersion: elasticache.aws.upbound.io/v1beta1
        kind: ReplicationGroup
        spec:
          forProvider:
            region: us-east-1
            description: "Crossplane managed Redis cluster"
            engine: redis
            engineVersion: "7.0"
            nodeType: cache.t3.micro
            numCacheClusters: 1
            automaticFailoverEnabled: false
            atRestEncryptionEnabled: true
            transitEncryptionEnabled: true
            port: 6379
            subnetGroupNameSelector:
              matchControllerRef: true
            securityGroupIdSelector:
              matchControllerRef: true
          writeConnectionSecretToRef:
            namespace: crossplane-system
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.replicationGroupId
          transforms:
            - type: string
              string:
                fmt: "%.40s"  # ElastiCache replication group ID max 40 chars

        # Version
        - type: FromCompositeFieldPath
          fromFieldPath: spec.version
          toFieldPath: spec.forProvider.engineVersion
          transforms:
            - type: string
              string:
                fmt: "%s.0"

        # Size mapping
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.nodeType
          transforms:
            - type: map
              map:
                small: cache.t3.micro
                medium: cache.t3.medium
                large: cache.r5.large

        # High availability
        - type: FromCompositeFieldPath
          fromFieldPath: spec.highAvailability
          toFieldPath: spec.forProvider.numCacheClusters
          transforms:
            - type: map
              map:
                "true": 2
                "false": 1
        - type: FromCompositeFieldPath
          fromFieldPath: spec.highAvailability
          toFieldPath: spec.forProvider.automaticFailoverEnabled

        # Encryption
        - type: FromCompositeFieldPath
          fromFieldPath: spec.encryption
          toFieldPath: spec.forProvider.transitEncryptionEnabled

        # Connection secret
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.writeConnectionSecretToRef.name
          transforms:
            - type: string
              string:
                fmt: "%s-cache-conn"

        # Status
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.primaryEndpointAddress
          toFieldPath: status.endpoint
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.port
          toFieldPath: status.port
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.cloud
          transforms:
            - type: string
              string:
                fmt: aws
