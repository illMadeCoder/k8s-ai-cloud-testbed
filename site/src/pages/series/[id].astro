---
import Base from '../../layouts/Base.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ExperimentGroupCard from '../../components/ExperimentGroupCard.astro';
import {
  loadAllExperiments,
  groupBySeries,
} from '../../lib/experiments';
import { loadSeries, getSeriesOrder } from '../../lib/series';
import type { ExperimentGroup } from '../../lib/experiments';

export function getStaticPaths() {
  const allSeries = loadSeries();
  const experiments = loadAllExperiments();
  const bySeries = groupBySeries(experiments);

  return allSeries.map((s) => {
    const groups = bySeries[s.id] ?? [];
    const order = getSeriesOrder(s.id);

    // Sort by series order array; unordered experiments come after ordered ones chronologically
    groups.sort((a, b) => {
      const ai = order.indexOf(a.baseName);
      const bi = order.indexOf(b.baseName);
      if (ai !== -1 && bi !== -1) return ai - bi;
      if (ai !== -1) return -1;
      if (bi !== -1) return 1;
      return new Date(b.latest.createdAt).getTime() - new Date(a.latest.createdAt).getTime();
    });

    return {
      params: { id: s.id },
      props: {
        series: s,
        groups,
      },
    };
  });
}

interface SeriesMeta {
  id: string;
  name: string;
  description: string;
}

interface Props {
  series: SeriesMeta;
  groups: ExperimentGroup[];
}

const { series, groups } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<Base title={`${series.name} â€” K8s Cloud TestBed`}>
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Series', href: `${base}series/` },
      { label: series.name },
    ]}
    slot="breadcrumb"
  />

  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-2">{series.name}</h1>
    <p class="text-text-muted max-w-2xl">{series.description}</p>
  </div>

  {groups.length === 0 ? (
    <div class="text-center py-16 text-text-muted">
      <p class="text-lg mb-2">Coming soon</p>
      <p class="text-sm">Experiments for this series are planned. Check back later.</p>
    </div>
  ) : (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {groups.map((group) => (
        <ExperimentGroupCard group={group} />
      ))}
    </div>
  )}
</Base>
