---
import Base from '../../layouts/Base.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import MetricCard from '../../components/MetricCard.astro';
import VegaChart from '../../components/VegaChart.astro';
import TargetTable from '../../components/TargetTable.astro';
import CostBreakdown from '../../components/CostBreakdown.astro';
import AnalysisAbstract from '../../components/AnalysisAbstract.astro';
import AnalysisSection from '../../components/AnalysisSection.astro';
import CapabilitiesMatrix from '../../components/CapabilitiesMatrix.astro';
import AnalysisBody from '../../components/AnalysisBody.astro';
import AnalysisFeedback from '../../components/AnalysisFeedback.astro';
import { loadAllExperiments, groupExperiments, getBaseName, formatDisplayName } from '../../lib/experiments';
import { formatDuration, formatDate, formatCost } from '../../lib/format';
import { buildSpec } from '../../lib/vega-specs';
import type { ExperimentSummary } from '../../types';
import type { ExperimentGroup } from '../../lib/experiments';

export function getStaticPaths() {
  const experiments = loadAllExperiments();
  const groups = groupExperiments(experiments);
  return groups.map((group) => ({
    params: { slug: group.baseName },
    props: { group },
  }));
}

interface Props {
  group: ExperimentGroup;
}

const { group } = Astro.props;
const { latest } = group;
const base = import.meta.env.BASE_URL;
const displayName = formatDisplayName(group.baseName);

const allMetricEntries = latest.metrics
  ? Object.entries(latest.metrics.queries).filter(([, qr]) => !qr.error)
  : [];
const metricEntries = allMetricEntries.filter(([, qr]) => qr.data && qr.data.length > 0);
const metricsEmpty = metricEntries.length === 0;

const hasRichAnalysis = !!latest.analysis?.abstract;
const analysis = latest.analysis;

---

<Base title={`${displayName} — K8s AI Lab Benchmarks`} description={latest.description}>
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Experiments', href: base },
      { label: displayName },
    ]}
    slot="breadcrumb"
  />

  <div class="detail-header">
    <div>
      <h1>{displayName}</h1>
      <p class="description">{latest.description}</p>
      {group.tags.length > 0 && (
        <div class="detail-tags">
          {group.tags.map((tag) => (
            <a href={`${base}tags/${tag}/`} class="tag tag-link">{tag}</a>
          ))}
        </div>
      )}
    </div>
  </div>

  {latest.study && (latest.study.hypothesis || latest.study.questions?.length || latest.study.focus?.length) && (
    <div class="study-context">
      {latest.study.hypothesis && (
        <div class="study-hypothesis">
          <span class="study-label">Hypothesis</span>
          <p>{latest.study.hypothesis}</p>
        </div>
      )}
      {latest.study.questions && latest.study.questions.length > 0 && (
        <div class="study-questions">
          <span class="study-label">Questions</span>
          <ol>
            {latest.study.questions.map((q) => <li>{q}</li>)}
          </ol>
        </div>
      )}
      {latest.study.focus && latest.study.focus.length > 0 && (
        <div class="study-focus">
          <span class="study-label">Focus Areas</span>
          <div class="focus-tags">
            {latest.study.focus.map((f) => <span class="focus-tag">{f}</span>)}
          </div>
        </div>
      )}
    </div>
  )}

  {/* Rich analysis: abstract replaces old analysis-box */}
  {hasRichAnalysis && analysis && (
    <AnalysisAbstract
      abstract={analysis.abstract!}
      model={analysis.model}
      generatedAt={analysis.generatedAt}
    />
  )}

  {/* Legacy analysis: old-style summary box */}
  {!hasRichAnalysis && analysis?.summary && (
    <div class="analysis-box">
      <h3 class="analysis-title">AI Analysis</h3>
      <p>{analysis.summary}</p>
    </div>
  )}

  <details class="section run-history">
    <summary class="section-title">Run History ({group.runs.length} {group.runs.length === 1 ? 'run' : 'runs'})</summary>
    <table>
      <thead>
        <tr>
          <th>Run</th>
          <th>Phase</th>
          <th>Date</th>
          <th>Duration</th>
          <th>Cost</th>
        </tr>
      </thead>
      <tbody>
        {group.runs.map((run) => {
          const runBadge = run.phase === 'Complete'
            ? 'badge-complete'
            : run.phase === 'Failed'
              ? 'badge-failed'
              : 'badge-running';
          return (
            <tr>
              <td>
                <a href={`${base}experiments/${group.baseName}/${run.name}/`}>
                  <code>{run.name}</code>
                </a>
              </td>
              <td><span class={`badge ${runBadge}`}>{run.phase}</span></td>
              <td>{formatDate(run.createdAt)}</td>
              <td>{formatDuration(run.durationSeconds)}</td>
              <td>{run.costEstimate ? formatCost(run.costEstimate.totalUSD) : '—'}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </details>

  <div class="stats-row">
    <MetricCard label="Created" value={formatDate(latest.createdAt)} />
    <MetricCard label="Duration" value={formatDuration(latest.durationSeconds)} />
    <MetricCard label="Targets" value={String(latest.targets.length)} />
    {latest.costEstimate && (
      <MetricCard label="Est. Cost" value={formatCost(latest.costEstimate.totalUSD)} />
    )}
    <MetricCard label="Workflow" value={latest.workflow.phase} />
  </div>

  <TargetTable targets={latest.targets} />

  {/* Rich analysis: Target Analysis section */}
  {hasRichAnalysis && analysis?.targetAnalysis && (
    <AnalysisSection
      title="Target Analysis"
      overview={analysis.targetAnalysis.overview}
      findings={analysis.targetAnalysis.perTarget
        ? Object.entries(analysis.targetAnalysis.perTarget).map(([name, insight]) => `${name}: ${insight}`)
        : undefined}
      extras={analysis.targetAnalysis.comparisonToBaseline ? [analysis.targetAnalysis.comparisonToBaseline] : undefined}
      extrasLabel="Comparison to Baseline"
      accent="blue"
    />
  )}

  {/* Rich analysis: Capabilities Matrix (comparisons only) */}
  {hasRichAnalysis && analysis?.capabilitiesMatrix && (
    <CapabilitiesMatrix matrix={analysis.capabilitiesMatrix} />
  )}

  {metricEntries.length > 0 && (
    <div class="section">
      <h2 class="section-title">Metrics</h2>
      {latest.metrics?.source && (
        <p class="metrics-source">Source: <code>{latest.metrics.source}</code></p>
      )}
      <div class="grid">
        {metricEntries.map(([name, qr]) => (
          <div class="card">
            <VegaChart spec={buildSpec(name, qr)} />
            {analysis?.metricInsights?.[name] && (
              <p class="metric-insight">{analysis.metricInsights[name]}</p>
            )}
          </div>
        ))}
      </div>
    </div>
  )}

  {metricsEmpty && (
    <div class="section">
      <h2 class="section-title">Metrics</h2>
      <div class="empty-state">
        <p>No metrics data collected for this experiment run.</p>
        <p class="empty-hint">The target cluster may not have had a monitoring stack deployed, or the queries returned no results. Re-running the experiment with the latest operator will attempt to collect metrics directly from the target cluster's Prometheus.</p>
      </div>
    </div>
  )}

  <script>
    import vegaEmbed from 'vega-embed';
    (window as any).vegaEmbed = vegaEmbed;
  </script>

  {/* Rich analysis: Performance Analysis */}
  {hasRichAnalysis && analysis?.performanceAnalysis && (
    <AnalysisSection
      title="Performance Analysis"
      overview={analysis.performanceAnalysis.overview}
      findings={analysis.performanceAnalysis.findings}
      extras={analysis.performanceAnalysis.bottlenecks}
      extrasLabel="Bottlenecks"
      accent="blue"
    />
  )}

  {/* Rich analysis: FinOps Analysis */}
  {hasRichAnalysis && analysis?.finopsAnalysis && (
    <AnalysisSection
      title="FinOps Analysis"
      overview={analysis.finopsAnalysis.overview}
      findings={analysis.finopsAnalysis.costDrivers}
      extras={analysis.finopsAnalysis.optimizations}
      extrasLabel="Optimizations"
      accent="green"
    />
  )}

  {/* Rich analysis: FinOps projection inline */}
  {hasRichAnalysis && analysis?.finopsAnalysis?.projection && (
    <div class="section finops-projection">
      <h4 class="projection-title">Production Cost Projection</h4>
      <p class="projection-text">{analysis.finopsAnalysis.projection}</p>
    </div>
  )}

  {latest.costEstimate && (
    <CostBreakdown cost={latest.costEstimate} />
  )}

  {/* Rich analysis: SecOps Analysis */}
  {hasRichAnalysis && analysis?.secopsAnalysis && (
    <AnalysisSection
      title="SecOps Analysis"
      overview={analysis.secopsAnalysis.overview}
      findings={analysis.secopsAnalysis.findings}
      extras={analysis.secopsAnalysis.supplyChain ? [analysis.secopsAnalysis.supplyChain] : undefined}
      extrasLabel="Supply Chain"
      accent="red"
    />
  )}

  {/* Rich analysis: Deep Dive */}
  {hasRichAnalysis && analysis?.body && (
    <AnalysisBody body={analysis.body} />
  )}

  {/* Rich analysis: Feedback & Recommendations */}
  {hasRichAnalysis && analysis?.feedback && (
    <AnalysisFeedback feedback={analysis.feedback} />
  )}

  {/* Legacy analysis: old-style recommendations */}
  {!hasRichAnalysis && analysis?.recommendations && analysis.recommendations.length > 0 && (
    <div class="section">
      <h2 class="section-title">Recommendations</h2>
      <ul class="recommendations">
        {analysis.recommendations.map((rec) => <li>{rec}</li>)}
      </ul>
    </div>
  )}
</Base>

<style>
  .detail-header {
    margin-bottom: 2rem;
  }
  .detail-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0.5rem 0 0.25rem;
    font-family: var(--font-mono);
    word-break: break-all;
  }
  .description {
    color: var(--text-muted);
    max-width: 700px;
    margin-bottom: 0.75rem;
  }
  .detail-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }
  .run-history summary {
    cursor: pointer;
    list-style: none;
  }
  .run-history summary::before {
    content: '\25B6 ';
    font-size: 0.75em;
    color: var(--text-muted);
  }
  .run-history[open] summary::before {
    content: '\25BC ';
  }
  .run-history summary::-webkit-details-marker {
    display: none;
  }
  .metrics-source {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
  }
  .metrics-source code {
    color: var(--accent);
  }
  .empty-state {
    padding: 2rem;
    border: 1px dashed var(--border);
    border-radius: 0.5rem;
    text-align: center;
    color: var(--text-muted);
  }
  .empty-state p {
    margin: 0.5rem 0;
  }
  .empty-hint {
    font-size: 0.85rem;
    max-width: 600px;
    margin: 0.5rem auto 0;
  }
  .finops-projection {
    background: color-mix(in srgb, var(--success) 6%, var(--bg-card));
    border: 1px solid color-mix(in srgb, var(--success) 20%, var(--border));
    border-radius: var(--radius);
    padding: 1rem 1.5rem;
  }
  .projection-title {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--success);
    margin-bottom: 0.5rem;
  }
  .projection-text {
    color: var(--text);
    line-height: 1.65;
    font-size: 0.9rem;
  }
  .study-context {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: var(--radius);
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .study-label {
    display: block;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: 0.35rem;
  }
  .study-hypothesis p {
    margin: 0;
    font-style: italic;
    color: var(--text);
    line-height: 1.6;
  }
  .study-questions ol {
    margin: 0;
    padding-left: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .study-questions li {
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.5;
  }
  .focus-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }
  .focus-tag {
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
  }
</style>
