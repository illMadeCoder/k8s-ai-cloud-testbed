---
import Base from '../../layouts/Base.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ExperimentDetail from '../../components/ExperimentDetail.astro';
import VoiceChat from '../../components/VoiceChat.astro';
import { loadAllExperiments, groupExperiments, getDisplayTitle, getSeriesSiblings, getHypothesisClaim } from '../../lib/experiments';
import { getSeriesMeta } from '../../lib/series';
import type { ExperimentGroup } from '../../lib/experiments';

export function getStaticPaths() {
  const experiments = loadAllExperiments();
  const groups = groupExperiments(experiments);
  return groups.map((group) => ({
    params: { slug: group.baseName },
    props: { group },
  }));
}

interface Props {
  group: ExperimentGroup;
}

const { group } = Astro.props;
const base = import.meta.env.BASE_URL;
const displayName = getDisplayTitle(group);

const experiments = loadAllExperiments();
const seriesId = group.latest.series;
let seriesSiblings: { seriesId: string; seriesName: string; groups: ExperimentGroup[] } | undefined;
if (seriesId) {
  const meta = getSeriesMeta(seriesId);
  const siblings = getSeriesSiblings(group.baseName, experiments);
  if (meta && siblings && siblings.length > 0) {
    seriesSiblings = { seriesId, seriesName: meta.name, groups: siblings };
  }
}

const experiment = group.latest;
const hypothesis = getHypothesisClaim(experiment);
const verdict = experiment.analysis?.hypothesisVerdict;
const abstract = experiment.analysis?.abstract;

let openingMessage: string;
if (abstract) {
  const firstSentence = abstract.split(/(?<=[.!?])\s/)[0];
  if (hypothesis && verdict) {
    openingMessage = `This experiment tested whether ${hypothesis.toLowerCase().replace(/\.$/, '')}. The result: ${verdict}. ${firstSentence} What would you like to know more about?`;
  } else if (hypothesis) {
    openingMessage = `This experiment explored whether ${hypothesis.toLowerCase().replace(/\.$/, '')}. ${firstSentence} What would you like to know more about?`;
  } else {
    openingMessage = `${firstSentence} What would you like to know more about?`;
  }
} else if (hypothesis) {
  openingMessage = `This experiment tested whether ${hypothesis.toLowerCase().replace(/\.$/, '')}. What would you like to know about the methodology or results?`;
} else {
  openingMessage = `Welcome! This is the "${displayName}" experiment. What would you like to know about it?`;
}
---

<Base title={`${displayName} â€” K8s AI Lab Benchmarks`} description={group.latest.description}>
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Experiments', href: base },
      { label: displayName },
    ]}
    slot="breadcrumb"
  />
  <ExperimentDetail
    experiment={group.latest}
    displayName={displayName}
    tags={group.tags}
    runHistory={{ baseName: group.baseName, runs: group.runs }}
    seriesSiblings={seriesSiblings}
  />
  <VoiceChat
    workerUrl="https://voice-proxy.illmadecoder.workers.dev"
    experimentName={displayName}
    openingMessage={openingMessage}
  />
</Base>
