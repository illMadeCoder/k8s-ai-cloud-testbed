---
import Base from '../../../layouts/Base.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import ExperimentDetail from '../../../components/ExperimentDetail.astro';
import { loadAllExperiments, getBaseName, getRunDisplayTitle, groupExperiments, getSeriesSiblings } from '../../../lib/experiments';
import { getSeriesMeta } from '../../../lib/series';
import type { ExperimentSummary } from '../../../types';
import type { ExperimentGroup } from '../../../lib/experiments';

export function getStaticPaths() {
  const experiments = loadAllExperiments();
  const groups = groupExperiments(experiments);
  const groupMap = new Map(groups.map((g) => [g.baseName, g.runs]));
  return experiments.map((exp) => ({
    params: { slug: getBaseName(exp.name), run: exp.name },
    props: { experiment: exp, siblingRuns: groupMap.get(getBaseName(exp.name)) ?? [exp] },
  }));
}

interface Props {
  experiment: ExperimentSummary;
  siblingRuns: ExperimentSummary[];
}

const { experiment, siblingRuns } = Astro.props;
const base = import.meta.env.BASE_URL;
const baseName = getBaseName(experiment.name);
const displayName = getRunDisplayTitle(experiment);

const experiments = loadAllExperiments();
const seriesId = experiment.series;
let seriesSiblings: { seriesId: string; seriesName: string; groups: ExperimentGroup[] } | undefined;
if (seriesId) {
  const meta = getSeriesMeta(seriesId);
  const siblings = getSeriesSiblings(baseName, experiments);
  if (meta && siblings && siblings.length > 1) {
    seriesSiblings = { seriesId, seriesName: meta.name, groups: siblings };
  }
}
---

<Base title={`${experiment.name} â€” K8s AI Lab Benchmarks`} description={experiment.description}>
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Experiments', href: base },
      { label: displayName, href: `${base}experiments/${baseName}/` },
      { label: experiment.name },
    ]}
    slot="breadcrumb"
  />
  <ExperimentDetail
    experiment={experiment}
    displayName={experiment.name}
    tags={experiment.tags ?? []}
    runHistory={siblingRuns.length > 1 ? {
      baseName,
      runs: siblingRuns,
      currentRunName: experiment.name,
    } : undefined}
    seriesSiblings={seriesSiblings}
  />
</Base>
