---
import Base from '../../../layouts/Base.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import ExperimentDetail from '../../../components/ExperimentDetail.astro';
import VoiceChat from '../../../components/VoiceChat.astro';
import { loadAllExperiments, getBaseName, getRunDisplayTitle, groupExperiments, getSeriesSiblings, getHypothesisClaim } from '../../../lib/experiments';
import { getSeriesMeta } from '../../../lib/series';
import type { ExperimentSummary } from '../../../types';
import type { ExperimentGroup } from '../../../lib/experiments';

export function getStaticPaths() {
  const experiments = loadAllExperiments();
  const groups = groupExperiments(experiments);
  const groupMap = new Map(groups.map((g) => [g.baseName, g.runs]));
  return experiments.map((exp) => ({
    params: { slug: getBaseName(exp.name), run: exp.name },
    props: { experiment: exp, siblingRuns: groupMap.get(getBaseName(exp.name)) ?? [exp] },
  }));
}

interface Props {
  experiment: ExperimentSummary;
  siblingRuns: ExperimentSummary[];
}

const { experiment, siblingRuns } = Astro.props;
const base = import.meta.env.BASE_URL;
const baseName = getBaseName(experiment.name);
const displayName = getRunDisplayTitle(experiment);

const experiments = loadAllExperiments();
const seriesId = experiment.series;
let seriesSiblings: { seriesId: string; seriesName: string; groups: ExperimentGroup[] } | undefined;
if (seriesId) {
  const meta = getSeriesMeta(seriesId);
  const siblings = getSeriesSiblings(baseName, experiments);
  if (meta && siblings && siblings.length > 0) {
    seriesSiblings = { seriesId, seriesName: meta.name, groups: siblings };
  }
}

const hypothesis = getHypothesisClaim(experiment);
const verdict = experiment.analysis?.hypothesisVerdict;
const abstract = experiment.analysis?.abstract;

let openingMessage: string;
if (abstract) {
  const firstSentence = abstract.split(/(?<=[.!?])\s/)[0];
  if (hypothesis && verdict) {
    openingMessage = `This experiment tested whether ${hypothesis.toLowerCase().replace(/\.$/, '')}. The result: ${verdict}. ${firstSentence} What would you like to know more about?`;
  } else if (hypothesis) {
    openingMessage = `This experiment explored whether ${hypothesis.toLowerCase().replace(/\.$/, '')}. ${firstSentence} What would you like to know more about?`;
  } else {
    openingMessage = `${firstSentence} What would you like to know more about?`;
  }
} else if (hypothesis) {
  openingMessage = `This experiment tested whether ${hypothesis.toLowerCase().replace(/\.$/, '')}. What would you like to know about the methodology or results?`;
} else {
  openingMessage = `Welcome! This is the "${displayName}" experiment. What would you like to know about it?`;
}
---

<Base title={`${experiment.name} â€” K8s AI Lab Benchmarks`} description={experiment.description}>
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Experiments', href: base },
      { label: displayName, href: `${base}experiments/${baseName}/` },
      { label: experiment.name },
    ]}
    slot="breadcrumb"
  />
  <ExperimentDetail
    experiment={experiment}
    displayName={experiment.name}
    tags={experiment.tags ?? []}
    runHistory={siblingRuns.length > 1 ? {
      baseName,
      runs: siblingRuns,
      currentRunName: experiment.name,
    } : undefined}
    seriesSiblings={seriesSiblings}
  />
  <VoiceChat
    workerUrl="https://voice-proxy.illmadecoder.workers.dev"
    experimentName={displayName}
    openingMessage={openingMessage}
  />
</Base>
