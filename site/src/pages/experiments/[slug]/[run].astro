---
import Base from '../../../layouts/Base.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import MetricCard from '../../../components/MetricCard.astro';
import VegaChart from '../../../components/VegaChart.astro';
import TargetTable from '../../../components/TargetTable.astro';
import CostBreakdown from '../../../components/CostBreakdown.astro';
import AnalysisAbstract from '../../../components/AnalysisAbstract.astro';
import AnalysisSection from '../../../components/AnalysisSection.astro';
import CapabilitiesMatrix from '../../../components/CapabilitiesMatrix.astro';
import AnalysisBody from '../../../components/AnalysisBody.astro';
import AnalysisFeedback from '../../../components/AnalysisFeedback.astro';
import ArchitectureDiagram from '../../../components/ArchitectureDiagram.astro';
import { loadAllExperiments, getBaseName, formatDisplayName, groupExperiments } from '../../../lib/experiments';
import { formatDuration, formatDate, formatCost, formatValue } from '../../../lib/format';
import { buildSpec } from '../../../lib/vega-specs';
import type { ExperimentSummary } from '../../../types';

export function getStaticPaths() {
  const experiments = loadAllExperiments();
  const groups = groupExperiments(experiments);
  const groupMap = new Map(groups.map((g) => [g.baseName, g.runs]));
  return experiments.map((exp) => ({
    params: { slug: getBaseName(exp.name), run: exp.name },
    props: { experiment: exp, siblingRuns: groupMap.get(getBaseName(exp.name)) ?? [exp] },
  }));
}

interface Props {
  experiment: ExperimentSummary;
  siblingRuns: ExperimentSummary[];
}

const { experiment, siblingRuns } = Astro.props;
const base = import.meta.env.BASE_URL;
const baseName = getBaseName(experiment.name);
const displayName = formatDisplayName(baseName);

const allMetricEntries = experiment.metrics
  ? Object.entries(experiment.metrics.queries).filter(([, qr]) => !qr.error)
  : [];
const metricEntries = allMetricEntries.filter(([, qr]) => qr.data && qr.data.length > 0);
const metricsEmpty = metricEntries.length === 0;

const hasRichAnalysis = !!experiment.analysis?.abstract;
const analysis = experiment.analysis;
const verdict = analysis?.hypothesisVerdict;
const verdictLabel = verdict
  ? verdict.charAt(0).toUpperCase() + verdict.slice(1)
  : null;
---

<Base title={`${experiment.name} — K8s AI Lab Benchmarks`} description={experiment.description}>
  <Breadcrumb
    crumbs={[
      { label: 'Home', href: base },
      { label: 'Experiments', href: base },
      { label: displayName, href: `${base}experiments/${baseName}/` },
      { label: experiment.name },
    ]}
    slot="breadcrumb"
  />

  <div class="detail-header">
    <div>
      <h1>{experiment.name}</h1>
      <p class="description">{experiment.description}</p>
      {experiment.tags && experiment.tags.length > 0 && (
        <div class="detail-tags">
          {experiment.tags.map((tag) => (
            <a href={`${base}tags/${tag}/`} class="tag tag-link">{tag}</a>
          ))}
        </div>
      )}
    </div>
  </div>

  <div class="stats-row">
    {verdictLabel && (
      <div class={`metric-card verdict-card verdict-${verdict!.replace(/\s+/g, '-')}`}>
        <span class="metric-label">Hypothesis</span>
        <span class="metric-value verdict-value">{verdictLabel}</span>
      </div>
    )}
    <MetricCard label="Created" value={formatDate(experiment.createdAt)} />
    <MetricCard label="Duration" value={formatDuration(experiment.durationSeconds)} />
    <MetricCard label="Targets" value={String(experiment.targets.length)} />
    {experiment.costEstimate && (
      <MetricCard label="Est. Cost" value={formatCost(experiment.costEstimate.totalUSD)} />
    )}
    <MetricCard label="Workflow" value={experiment.workflow.phase} />
  </div>

  <details class="section">
    <summary class="section-title">Metadata</summary>
    <TargetTable targets={experiment.targets} />
    {experiment.costEstimate && (
      <CostBreakdown cost={experiment.costEstimate} />
    )}
    {siblingRuns.length > 1 && (
      <details class="section run-history">
        <summary class="section-title">Run History ({siblingRuns.length} runs)</summary>
        <table>
          <thead>
            <tr>
              <th>Run</th>
              <th>Hypothesis</th>
              <th>Date</th>
              <th>Duration</th>
              <th>Cost</th>
            </tr>
          </thead>
          <tbody>
            {siblingRuns.map((run) => {
              const isCurrent = run.name === experiment.name;
              const runVerdict = run.analysis?.hypothesisVerdict;
              return (
                <tr class={isCurrent ? 'current-run' : ''}>
                  <td>
                    {isCurrent ? (
                      <code class="current-run-name">{run.name}</code>
                    ) : (
                      <a href={`${base}experiments/${baseName}/${run.name}/`}>
                        <code>{run.name}</code>
                      </a>
                    )}
                  </td>
                  <td>{runVerdict ? (
                    <span class={`badge verdict-badge verdict-badge-${runVerdict.replace(/\s+/g, '-')}`}>{runVerdict}</span>
                  ) : '—'}</td>
                  <td>{formatDate(run.createdAt)}</td>
                  <td>{formatDuration(run.durationSeconds)}</td>
                  <td>{run.costEstimate ? formatCost(run.costEstimate.totalUSD) : '—'}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </details>
    )}
  </details>

  {(experiment.study?.hypothesis || experiment.study?.questions?.length || experiment.study?.focus?.length || hasRichAnalysis || analysis?.summary) && (
    <details class="section overview" open>
      <summary class="section-title">Overview</summary>
      <div class="overview-inner">
        {experiment.study?.hypothesis && (
          <details class="overview-item" open>
            <summary class="overview-item-title">Hypothesis</summary>
            <div class="overview-item-content">
              <p class="study-hypothesis-text">{experiment.study.hypothesis}</p>
            </div>
          </details>
        )}
        {hasRichAnalysis && analysis && (
          <details class="overview-item" open>
            <summary class="overview-item-title">Abstract</summary>
            <div class="overview-item-content">
              <AnalysisAbstract
                abstract={analysis.abstract!}
                model={analysis.model}
                generatedAt={analysis.generatedAt}
              />
            </div>
          </details>
        )}
        {experiment.study?.questions && experiment.study.questions.length > 0 && (
          <details class="overview-item" open>
            <summary class="overview-item-title">Questions</summary>
            <div class="overview-item-content">
              <ol class="study-questions-list">
                {experiment.study.questions.map((q) => <li>{q}</li>)}
              </ol>
            </div>
          </details>
        )}
        {experiment.study?.focus && experiment.study.focus.length > 0 && (
          <details class="overview-item" open>
            <summary class="overview-item-title">Focus Areas</summary>
            <div class="overview-item-content">
              <div class="focus-tags">
                {experiment.study.focus.map((f) => <span class="focus-tag">{f}</span>)}
              </div>
            </div>
          </details>
        )}
        {analysis?.architectureDiagram && (
          <details class="overview-item" open>
            <summary class="overview-item-title">Architecture</summary>
            <div class="overview-item-content">
              <ArchitectureDiagram diagram={analysis.architectureDiagram} />
            </div>
          </details>
        )}
        {!hasRichAnalysis && analysis?.summary && (
          <details class="overview-item" open>
            <summary class="overview-item-title">Summary</summary>
            <div class="overview-item-content">
              <div class="analysis-box">
                <p>{analysis.summary}</p>
              </div>
            </div>
          </details>
        )}
      </div>
    </details>
  )}

  {/* Rich analysis: Target Analysis section */}
  {hasRichAnalysis && analysis?.targetAnalysis && (
    <AnalysisSection
      title="Target Analysis"
      overview={analysis.targetAnalysis.overview}
      findings={analysis.targetAnalysis.perTarget
        ? Object.entries(analysis.targetAnalysis.perTarget).map(([name, insight]) => `${name}: ${insight}`)
        : undefined}
      extras={analysis.targetAnalysis.comparisonToBaseline ? [analysis.targetAnalysis.comparisonToBaseline] : undefined}
      extrasLabel="Comparison to Baseline"

    />
  )}

  {/* Rich analysis: Capabilities Matrix (comparisons only) */}
  {hasRichAnalysis && analysis?.capabilitiesMatrix && (
    <CapabilitiesMatrix matrix={analysis.capabilitiesMatrix} />
  )}

  {metricEntries.length > 0 && (
    <details class="section">
      <summary class="section-title">Metrics ({metricEntries.length})</summary>
      <div class="metrics-list">
        {metricEntries.map(([name, qr]) => (
          <div class="metric-panel">
            <div class="metric-panel-header">
              <code class="metric-panel-name">{name}</code>
              {qr.unit && <span class="metric-panel-unit">{qr.unit}</span>}
            </div>
            {qr.data && qr.data.length === 1 ? (
              <div class="metric-single-value">
                <span class="metric-single-number">{formatValue(qr.data[0].value, qr.unit)}</span>
                {qr.description && <span class="metric-single-desc">{qr.description}</span>}
              </div>
            ) : (
              <VegaChart spec={buildSpec(name, qr)} />
            )}
            {analysis?.metricInsights?.[name] && (
              <p class="metric-panel-insight">{analysis.metricInsights[name]}</p>
            )}
          </div>
        ))}
      </div>
    </details>
  )}

  {metricsEmpty && (
    <details class="section">
      <summary class="section-title">Metrics</summary>
      <div class="empty-state">
        <p>No metrics data collected for this experiment run.</p>
        <p class="empty-hint">The target cluster may not have had a monitoring stack deployed, or the queries returned no results.</p>
      </div>
    </details>
  )}

  {/* Rich analysis: Performance Analysis */}
  {hasRichAnalysis && analysis?.performanceAnalysis && (
    <AnalysisSection
      title="Performance Analysis"
      overview={analysis.performanceAnalysis.overview}
      findings={analysis.performanceAnalysis.findings}
      extras={analysis.performanceAnalysis.bottlenecks}
      extrasLabel="Bottlenecks"

    />
  )}

  {/* Rich analysis: Deep Dive */}
  {hasRichAnalysis && analysis?.body && (
    <AnalysisBody body={analysis.body} />
  )}

  {/* Rich analysis: FinOps Analysis */}
  {hasRichAnalysis && analysis?.finopsAnalysis && (
    <AnalysisSection
      title="FinOps Analysis"
      overview={analysis.finopsAnalysis.overview}
      findings={analysis.finopsAnalysis.costDrivers}
      extras={analysis.finopsAnalysis.optimizations}
      extrasLabel="Optimizations"
    />
  )}

  {/* Rich analysis: FinOps projection inline */}
  {hasRichAnalysis && analysis?.finopsAnalysis?.projection && (
    <details class="section">
      <summary class="section-title">Production Cost Projection</summary>
      <p class="projection-text">{analysis.finopsAnalysis.projection}</p>
    </details>
  )}

  {/* Rich analysis: SecOps Analysis */}
  {hasRichAnalysis && analysis?.secopsAnalysis && (
    <AnalysisSection
      title="SecOps Analysis"
      overview={analysis.secopsAnalysis.overview}
      findings={analysis.secopsAnalysis.findings}
      extras={analysis.secopsAnalysis.supplyChain ? [analysis.secopsAnalysis.supplyChain] : undefined}
      extrasLabel="Supply Chain"
    />
  )}

  {/* Rich analysis: Future Enhancements */}
  {hasRichAnalysis && analysis?.feedback && (
    <AnalysisFeedback feedback={analysis.feedback} />
  )}

  {/* Legacy analysis: old-style recommendations */}
  {!hasRichAnalysis && analysis?.recommendations && analysis.recommendations.length > 0 && (
    <details class="section">
      <summary class="section-title">Recommendations</summary>
      <ul class="recommendations">
        {analysis.recommendations.map((rec) => <li>{rec}</li>)}
      </ul>
    </details>
  )}

  <script>
    import vegaEmbed from 'vega-embed';
    (window as any).vegaEmbed = vegaEmbed;
  </script>
</Base>

<style>
  .detail-header {
    margin-bottom: 2rem;
  }
  .detail-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0.5rem 0 0.25rem;
    font-family: var(--font-mono);
    word-break: break-all;
  }
  .description {
    color: var(--text-muted);
    margin-bottom: 0.75rem;
  }
  .detail-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.125rem;
  }
  .verdict-card {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem 1.25rem;
    border-radius: var(--radius);
    min-width: 140px;
  }
  .verdict-value {
    font-size: 1.05rem;
  }
  .verdict-supported {
    background: color-mix(in srgb, #22c55e 15%, var(--bg-surface));
  }
  .verdict-supported .verdict-value {
    color: #22c55e;
  }
  .verdict-unsupported {
    background: color-mix(in srgb, #ef4444 15%, var(--bg-surface));
  }
  .verdict-unsupported .verdict-value {
    color: #ef4444;
  }
  .verdict-insufficient {
    background: var(--bg-surface);
  }
  .verdict-insufficient .verdict-value {
    color: var(--text-muted);
  }
  .current-run {
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }
  .current-run-name {
    font-weight: 700;
    color: var(--accent);
  }
  .verdict-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.15rem 0.5rem;
    border-radius: 2px;
    text-transform: capitalize;
  }
  .verdict-badge-supported {
    background: color-mix(in srgb, #22c55e 15%, transparent);
    color: #22c55e;
  }
  .verdict-badge-unsupported {
    background: color-mix(in srgb, #ef4444 15%, transparent);
    color: #ef4444;
  }
  .verdict-badge-insufficient {
    background: var(--bg-surface);
    color: var(--text-muted);
  }
  .empty-state {
    padding: 2rem;
    border: 1px dashed var(--border);
    border-radius: 0.5rem;
    text-align: center;
    color: var(--text-muted);
  }
  .empty-state p {
    margin: 0.5rem 0;
  }
  .empty-hint {
    font-size: 0.85rem;
    max-width: 600px;
    margin: 0.5rem auto 0;
  }
  .projection-text {
    color: var(--text);
    line-height: 1.65;
    font-size: 0.9rem;
  }
  .metadata-inner {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .overview-inner {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .overview-item {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .overview-item-title {
    display: block;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    padding: 0.5rem 1rem;
    cursor: pointer;
    user-select: none;
    list-style: none;
  }
  .overview-item-title::-webkit-details-marker {
    display: none;
  }
  .overview-item-title::before {
    content: '▶';
    display: inline-block;
    font-size: 0.55rem;
    margin-right: 0.5rem;
    transition: transform 0.15s ease;
    vertical-align: middle;
  }
  .overview-item[open] > .overview-item-title::before {
    transform: rotate(90deg);
  }
  .overview-item-content {
    padding: 0 1rem 0.75rem;
  }
  .study-hypothesis-text {
    margin: 0;
    font-style: italic;
    color: var(--text);
    line-height: 1.6;
  }
  .study-questions-list {
    margin: 0;
    padding-left: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .study-questions-list li {
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.5;
  }
  .focus-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.125rem;
  }
  .focus-tag {
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 2px;
  }
  .metrics-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }
  .metric-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .metric-panel-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
  }
  .metric-panel-name {
    font-family: var(--font-mono);
    font-size: 1.05rem;
    font-weight: 600;
    background: none;
    padding: 0;
  }
  .metric-panel-unit {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background: var(--bg-surface);
    padding: 0.1rem 0.4rem;
    border-radius: 2px;
  }
  .metric-single-value {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 1.5rem 1rem;
  }
  .metric-single-number {
    font-family: var(--font-mono);
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
  }
  .metric-single-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
  }
  .metric-panel-insight {
    margin: 0;
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border);
    font-size: 0.9rem;
    color: var(--text);
    line-height: 1.65;
  }
</style>
