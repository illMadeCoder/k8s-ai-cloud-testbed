---
import Base from '../layouts/Base.astro';
import Hero from '../components/Hero.astro';
import ExperimentGroupCard from '../components/ExperimentGroupCard.astro';
import ProjectCard from '../components/ProjectCard.astro';
import {
  loadAllExperiments,
  groupExperiments,
  groupByProject,
  getStats,
} from '../lib/experiments';
import { loadCategories } from '../lib/categories';
import { loadProjects } from '../lib/projects';

const experiments = loadAllExperiments();
const groups = groupExperiments(experiments);
const stats = getStats(experiments);
const categories = loadCategories();
const projects = loadProjects();
const projectGroups = groupByProject(experiments);
const recentGroups = groups.slice(0, 6);
---

<Base title="K8s Cloud TestBed — Automated Kubernetes Benchmarks">
  <Hero
    experimentCount={stats.experimentCount}
    projectCount={projects.length}
    componentCount={stats.componentCount}
    totalRuns={stats.totalRuns}
    totalCostUSD={stats.totalCostUSD}
  >
    <div class="arch">
      <div class="arch-node arch-hub">
        <div class="arch-name">Hub Cluster</div>
        <div class="arch-detail">Talos · Experiment CRs · ArgoCD · Crossplane</div>
      </div>
      <div class="conn-fan">
        <div class="conn-cell"><div class="conn-v"></div><div class="conn-arrow"></div></div>
        <div class="conn-cell"><div class="conn-v"></div><div class="conn-arrow"></div></div>
        <div class="conn-cell"><div class="conn-v"></div><div class="conn-arrow"></div></div>
      </div>
      <div class="arch-row">
        <div class="arch-node">
          <div class="arch-name">GKE</div>
          <div class="arch-detail">Google Cloud</div>
        </div>
        <div class="arch-node">
          <div class="arch-name">EKS</div>
          <div class="arch-detail">AWS</div>
        </div>
        <div class="arch-node">
          <div class="arch-name">AKS</div>
          <div class="arch-detail">Azure</div>
        </div>
      </div>
      <div class="conn-merge">
        <div class="conn-merge-stems">
          <div class="conn-cell"><div class="conn-v-short"></div></div>
          <div class="conn-cell"><div class="conn-v-short"></div></div>
          <div class="conn-cell"><div class="conn-v-short"></div></div>
        </div>
        <div class="conn-h"></div>
        <div class="conn-v-center"></div>
        <div class="conn-arrow"></div>
        <div class="conn-label">metrics</div>
      </div>
      <div class="arch-node arch-ai">
        <div class="arch-name">AI Analysis</div>
        <div class="arch-detail">Argo Workflows · Agentic</div>
      </div>
      <div class="conn-single">
        <div class="conn-v-center"></div>
        <div class="conn-arrow"></div>
      </div>
      <div class="arch-node arch-here">
        <span class="arch-here-ping"></span>
        <div class="arch-name">You are here</div>
      </div>
    </div>
  </Hero>

  <section class="mb-12">
    <h2 class="text-xl font-semibold mb-4">Ongoing Projects</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {projects.map((p) => (
        <ProjectCard
          id={p.id}
          name={p.name}
          description={p.description}
          experimentCount={(projectGroups[p.id] ?? []).length}
        />
      ))}
    </div>
  </section>

  <section class="mb-12">
    <h2 class="text-xl font-semibold mb-4">Recent Experiments</h2>
    {recentGroups.length === 0 ? (
      <div class="text-center py-16 text-text-muted">
        <p class="text-lg mb-2">No experiments yet</p>
        <p class="text-sm">
          Experiments will appear here once the operator publishes results to
          <code class="text-xs bg-bg-surface px-1.5 py-0.5 rounded">site/data/</code>
        </p>
      </div>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {recentGroups.map((group) => (
          <ExperimentGroupCard group={group} />
        ))}
      </div>
    )}
  </section>

</Base>

<style>
  .arch {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0;
    width: 100%;
    min-height: 100%;
    --line: color-mix(in srgb, var(--accent) 50%, transparent);
  }

  /* --- nodes --- */
  .arch-node {
    border: 1px solid var(--line);
    border-radius: 6px;
    padding: 0.6rem 1.25rem;
    text-align: center;
    font-family: var(--font-mono);
    background: transparent;
  }
  .arch-hub { width: 80%; }
  .arch-name { font-size: 0.9rem; font-weight: 700; color: var(--text); line-height: 1.3; }
  .arch-detail { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.15rem; line-height: 1.3; }
  .arch-row { display: flex; gap: 0.5rem; width: 90%; justify-content: center; }
  .arch-row .arch-node { flex: 1; min-width: 0; padding: 0.5rem 0.4rem; }
  .arch-ai { width: 55%; }

  /* --- shared connector primitives --- */
  .conn-v { width: 1px; height: 14px; background: var(--line); }
  .conn-v-short { width: 1px; height: 6px; background: var(--line); }
  .conn-v-center { width: 1px; height: 10px; background: var(--line); margin: 0 auto; }
  .conn-h { width: 100%; height: 1px; background: var(--line); }
  .conn-arrow {
    width: 0; height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 6px solid var(--line);
    margin: 0 auto;
  }
  .conn-cell { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 0; }
  .conn-label {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: 0.06em;
    text-align: center;
    margin-top: 0.2rem;
  }

  /* --- fan-out: hub → 3 clouds --- */
  .conn-fan { display: flex; gap: 0.5rem; width: 90%; }

  /* --- merge: 3 clouds → 1 --- */
  .conn-merge { width: 90%; }
  .conn-merge-stems { display: flex; gap: 0.5rem; }

  /* --- single line --- */
  .conn-single { display: flex; flex-direction: column; align-items: center; }

  /* --- you are here --- */
  .arch-here {
    position: relative;
    border-color: var(--accent);
    box-shadow: 0 0 12px color-mix(in srgb, var(--accent) 20%, transparent);
    padding: 0.5rem 1.25rem;
  }
  .arch-here .arch-name { color: var(--accent); font-size: 0.8rem; }
  .arch-here-ping {
    position: absolute;
    top: -3px; right: -3px;
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 6px var(--accent);
    animation: ping 2s ease-in-out infinite;
  }
  @keyframes ping {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--accent); }
    50% { opacity: 0.4; box-shadow: 0 0 10px var(--accent); }
  }
</style>
