---
import MetricCard from './MetricCard.astro';
import VegaChart from './VegaChart.astro';
import TargetTable from './TargetTable.astro';
import CostBreakdown from './CostBreakdown.astro';
import AnalysisAbstract from './AnalysisAbstract.astro';
import CapabilitiesMatrix from './CapabilitiesMatrix.astro';
import AnalysisBody from './AnalysisBody.astro';
import AnalysisFeedback from './AnalysisFeedback.astro';
import ArchitectureDiagram from './ArchitectureDiagram.astro';
import ExperimentGroupCard from './ExperimentGroupCard.astro';
import { formatDuration, formatDate, formatCost, formatValue } from '../lib/format';
import { buildSpec } from '../lib/vega-specs';
import { getHypothesisClaim, getQuestions, getFocus, getMachineVerdict, getBaseName } from '../lib/experiments';
import { experimentToMarkdown } from '../lib/markdown';
import type { ExperimentSummary } from '../types';
import type { ExperimentGroup } from '../lib/experiments';

interface Props {
  experiment: ExperimentSummary;
  displayName: string;
  tags: string[];
  runHistory?: {
    baseName: string;
    runs: ExperimentSummary[];
    currentRunName?: string;
  };
  seriesSiblings?: {
    seriesId: string;
    seriesName: string;
    groups: ExperimentGroup[];
  };
}

const { experiment, displayName, tags, runHistory, seriesSiblings } = Astro.props;
const currentBaseName = getBaseName(experiment.name);
const base = import.meta.env.BASE_URL;

const allMetricEntries = experiment.metrics
  ? Object.entries(experiment.metrics.queries).filter(([, qr]) => !qr.error)
  : [];
const metricEntries = allMetricEntries.filter(([, qr]) => qr.data && qr.data.length > 0);
const metricsEmpty = metricEntries.length === 0;

const hasRichAnalysis = !!experiment.analysis?.abstract;
const analysis = experiment.analysis;
const verdict = analysis?.hypothesisVerdict;
const verdictLabel = verdict
  ? verdict.charAt(0).toUpperCase() + verdict.slice(1)
  : null;

const hypothesisClaim = getHypothesisClaim(experiment);
const questions = getQuestions(experiment);
const focusAreas = getFocus(experiment);
const machineVerdict = getMachineVerdict(experiment);
const markdown = experimentToMarkdown({ experiment, displayName, tags });
---

<div class="detail-header">
  <div>
    <h1>{displayName}</h1>
    <p class="description">{experiment.description}</p>
    {tags.length > 0 && (
      <div class="detail-tags">
        {tags.map((tag) => (
          <a href={`${base}tags/${tag}/`} class="tag tag-link">{tag}</a>
        ))}
      </div>
    )}
  </div>
</div>

<div class="stats-row">
  {verdictLabel && (
    <div class={`metric-card verdict-card verdict-${verdict!.replace(/\s+/g, '-')}`}>
      <span class="metric-label">Hypothesis</span>
      <span class="metric-value verdict-value">{verdictLabel}</span>
    </div>
  )}
  {machineVerdict && !verdictLabel && (
    <div class={`metric-card verdict-card verdict-${machineVerdict}`}>
      <span class="metric-label">Hypothesis</span>
      <span class="metric-value verdict-value">{machineVerdict.charAt(0).toUpperCase() + machineVerdict.slice(1)}</span>
    </div>
  )}
  <MetricCard label="Created" value={formatDate(experiment.createdAt)} />
  <MetricCard label="Duration" value={formatDuration(experiment.durationSeconds)} />
  <MetricCard label="Targets" value={String(experiment.targets.length)} />
  {experiment.costEstimate && (
    <MetricCard label="Est. Cost" value={formatCost(experiment.costEstimate.totalUSD)} />
  )}
  <button class="metric-card copy-btn" id="copy-page-btn">
    <span class="metric-label">Export</span>
    <span class="metric-value copy-btn-label">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
      </svg>
      Copy
    </span>
  </button>
</div>

{analysis?.architectureDiagram && (
  <div class="architecture-hero">
    <ArchitectureDiagram diagram={analysis.architectureDiagram} format={analysis.architectureDiagramFormat} />
  </div>
)}

<details class="section section-metadata">
  <summary class="section-title">Metadata</summary>
  <TargetTable targets={experiment.targets} />
  {experiment.costEstimate && (
    <CostBreakdown cost={experiment.costEstimate} />
  )}
  {runHistory && (
    <details class="section run-history">
      <summary class="section-title">Run History ({runHistory.runs.length} {runHistory.runs.length === 1 ? 'run' : 'runs'})</summary>
      <table>
        <thead>
          <tr>
            <th>Run</th>
            <th>Hypothesis</th>
            <th>Date</th>
            <th>Duration</th>
            <th>Cost</th>
          </tr>
        </thead>
        <tbody>
          {runHistory.runs.map((run) => {
            const isCurrent = runHistory.currentRunName ? run.name === runHistory.currentRunName : false;
            const runVerdict = run.analysis?.hypothesisVerdict;
            return (
              <tr class={isCurrent ? 'current-run' : ''}>
                <td>
                  {isCurrent ? (
                    <code class="current-run-name">{run.name}</code>
                  ) : (
                    <a href={`${base}experiments/${runHistory.baseName}/${run.name}/`}>
                      <code>{run.name}</code>
                    </a>
                  )}
                </td>
                <td>{runVerdict ? (
                  <span class={`badge verdict-badge verdict-badge-${runVerdict.replace(/\s+/g, '-')}`}>{runVerdict}</span>
                ) : '—'}</td>
                <td>{formatDate(run.createdAt)}</td>
                <td>{formatDuration(run.durationSeconds)}</td>
                <td>{run.costEstimate ? formatCost(run.costEstimate.totalUSD) : '—'}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </details>
  )}
</details>

{(hypothesisClaim || questions.length > 0 || focusAreas.length > 0 || hasRichAnalysis || analysis?.summary) && (
  <details class="section section-overview">
    <summary class="section-title">Overview</summary>
    {hypothesisClaim && (
      <details class="section" open>
        <summary class="section-title">Hypothesis</summary>
        <p class="study-hypothesis-text">{hypothesisClaim}</p>
      </details>
    )}
    {hasRichAnalysis && analysis && (
      <details class="section" open>
        <summary class="section-title">Abstract</summary>
        <AnalysisAbstract
          abstract={analysis.abstract!}
          model={analysis.model}
          generatedAt={analysis.generatedAt}
        />
      </details>
    )}
    {questions.length > 0 && (
      <details class="section" open>
        <summary class="section-title">Questions</summary>
        <div class="study-questions-list">
          {questions.map((q, i) => (
            <div class="study-question-card">
              <div class="study-question-header">
                <span class="study-question-number">{i + 1}</span>
              </div>
              <p class="study-question-text">{q}</p>
            </div>
          ))}
        </div>
      </details>
    )}
    {focusAreas.length > 0 && (
      <details class="section" open>
        <summary class="section-title">Focus Areas</summary>
        <div class="focus-tags">
          {focusAreas.map((f) => <span class="focus-tag">{f}</span>)}
        </div>
      </details>
    )}
    {!hasRichAnalysis && analysis?.summary && (
      <details class="section">
        <summary class="section-title">Summary</summary>
        <div class="analysis-box">
          <p>{analysis.summary}</p>
        </div>
      </details>
    )}
  </details>
)}

{/* Rich analysis: Capabilities Matrix (comparisons only) */}
{hasRichAnalysis && analysis?.capabilitiesMatrix && (
  <CapabilitiesMatrix matrix={analysis.capabilitiesMatrix} />
)}

{/* Rich analysis: Body (block-based narrative) */}
{hasRichAnalysis && analysis?.body && (
  <AnalysisBody body={analysis.body} metrics={experiment.metrics} />
)}

{metricEntries.length > 0 && (
  <details class="section section-metrics">
    <summary class="section-title">Metrics ({metricEntries.length})</summary>
    <div class="metrics-list">
      {metricEntries.map(([name, qr]) => (
        <div class="metric-panel">
          <div class="metric-panel-header">
            <code class="metric-panel-name">{name}</code>
            {qr.unit && <span class="metric-panel-unit">{qr.unit}</span>}
          </div>
          {qr.data && qr.data.length === 1 ? (
            <div class="metric-single-value">
              <span class="metric-single-number">{formatValue(qr.data[0].value, qr.unit)}</span>
              {qr.description && <span class="metric-single-desc">{qr.description}</span>}
            </div>
          ) : (
            <VegaChart spec={buildSpec(name, qr)} />
          )}
          {analysis?.metricInsights?.[name] && (
            <p class="metric-panel-insight">{analysis.metricInsights[name]}</p>
          )}
        </div>
      ))}
    </div>
  </details>
)}

{metricsEmpty && (
  <details class="section section-metrics">
    <summary class="section-title">Metrics</summary>
    <div class="empty-state">
      <p>No metrics data collected for this experiment run.</p>
      <p class="empty-hint">The target cluster may not have had a monitoring stack deployed, or the queries returned no results.</p>
    </div>
  </details>
)}

{/* Rich analysis: Future Enhancements */}
{hasRichAnalysis && analysis?.feedback && (
  <AnalysisFeedback feedback={analysis.feedback} />
)}

{seriesSiblings && (() => {
  const idx = seriesSiblings.groups.findIndex((g) => g.baseName === currentBaseName);
  const nextGroups = idx !== -1 ? seriesSiblings.groups.slice(idx + 1) : seriesSiblings.groups;
  return (
    <details class="section section-series series-nav">
      <summary class="section-title">
        {nextGroups.length > 0 ? 'Next' : 'Part of'} <a href={`${base}series/${seriesSiblings.seriesId}/`} class="series-link">{seriesSiblings.seriesName}</a>
      </summary>
      {nextGroups.length > 0 ? (
        <div class="series-cards">
          {nextGroups.map((g) => (
            <ExperimentGroupCard group={g} />
          ))}
        </div>
      ) : (
        <div class="series-end">
          <p>You've reached the end of this series.</p>
          <a href={`${base}series/${seriesSiblings.seriesId}/`} class="series-end-link">
            View all in {seriesSiblings.seriesName} &rarr;
          </a>
        </div>
      )}
    </details>
  );
})()}

<script>
  import vegaEmbed from 'vega-embed';
  (window as any).vegaEmbed = vegaEmbed;
</script>
<script>
  import mermaid from 'mermaid';
  (window as any).mermaidLib = mermaid;
  window.dispatchEvent(new CustomEvent('mermaid:ready'));
</script>
<div id="page-markdown" style="display:none" set:text={markdown}></div>
<script is:inline>
  (function() {
    var btn = document.getElementById('copy-page-btn');
    if (!btn) return;

    btn.addEventListener('click', function() {
      var md = document.getElementById('page-markdown');
      if (!md) return;

      navigator.clipboard.writeText(md.textContent).then(function() {
        var label = btn.querySelector('.copy-btn-label');
        if (!label) return;
        var original = label.innerHTML;
        label.textContent = 'Copied!';
        setTimeout(function() { label.innerHTML = original; }, 1500);
      });
    });
  })();
</script>

<style>
  .detail-header {
    margin-bottom: 2rem;
  }
  .detail-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0.5rem 0 0.25rem;
    font-family: var(--font-mono);
    word-break: break-all;
  }
  .description {
    color: var(--text-muted);
    margin-bottom: 0.75rem;
  }
  .detail-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.125rem;
  }
  .verdict-card {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem 1.25rem;
    border-radius: var(--radius);
    min-width: 140px;
  }
  .verdict-value {
    font-size: 1.05rem;
  }
  .verdict-validated {
    background: color-mix(in srgb, #22c55e 15%, var(--bg-surface));
  }
  .verdict-validated .verdict-value {
    color: #22c55e;
  }
  .verdict-invalidated {
    background: color-mix(in srgb, #ef4444 15%, var(--bg-surface));
  }
  .verdict-invalidated .verdict-value {
    color: #ef4444;
  }
  .verdict-insufficient {
    background: var(--bg-surface);
  }
  .verdict-insufficient .verdict-value {
    color: var(--text-muted);
  }
  .current-run {
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }
  .current-run-name {
    font-weight: 700;
    color: var(--accent);
  }
  .verdict-badge {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.15rem 0.5rem;
    border-radius: 2px;
    text-transform: capitalize;
  }
  .verdict-badge-validated {
    background: color-mix(in srgb, #22c55e 15%, transparent);
    color: #22c55e;
  }
  .verdict-badge-invalidated {
    background: color-mix(in srgb, #ef4444 15%, transparent);
    color: #ef4444;
  }
  .verdict-badge-insufficient {
    background: var(--bg-surface);
    color: var(--text-muted);
  }
  .empty-state {
    padding: 2rem;
    border: 1px dashed var(--border);
    border-radius: 0.5rem;
    text-align: center;
    color: var(--text-muted);
  }
  .empty-state p {
    margin: 0.5rem 0;
  }
  .empty-hint {
    font-size: 0.85rem;
    max-width: 600px;
    margin: 0.5rem auto 0;
  }
  .study-hypothesis-text {
    margin: 0;
    font-style: italic;
    color: var(--text);
    line-height: 1.6;
  }
  .study-questions-list {
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .study-question-card {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.75rem 1rem;
  }
  .study-question-header {
    flex-shrink: 0;
  }
  .study-question-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
    border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent);
    border-radius: 3px;
  }
  .study-question-text {
    margin: 0;
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.5;
    padding-top: 0.1rem;
  }
  .focus-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.125rem;
  }
  .focus-tag {
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 2px;
  }
  .metrics-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }
  .metric-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .metric-panel-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
  }
  .metric-panel-name {
    font-family: var(--font-mono);
    font-size: 1.05rem;
    font-weight: 600;
    background: none;
    padding: 0;
  }
  .metric-panel-unit {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background: var(--bg-surface);
    padding: 0.1rem 0.4rem;
    border-radius: 2px;
  }
  .metric-single-value {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 1.5rem 1rem;
  }
  .metric-single-number {
    font-family: var(--font-mono);
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
  }
  .metric-single-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
  }
  .metric-panel-insight {
    margin: 0;
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border);
    font-size: 0.9rem;
    color: var(--text);
    line-height: 1.65;
  }

  .architecture-hero {
    margin: 2rem -0.5rem;
  }
  .architecture-hero :global(.mermaid-wrapper) {
    border-radius: var(--radius);
  }
  .architecture-hero :global(.mermaid-container) {
    padding: 1.5rem 2rem;
  }
  .architecture-hero :global(.arch-diagram) {
    padding: 1.5rem 2rem;
    margin: 0;
  }

  .series-nav {
    margin-top: 0;
  }
  .series-link {
    color: var(--accent);
    text-decoration: none;
  }
  .series-link:hover {
    text-decoration: underline;
  }
  .series-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    padding: 1rem;
  }

  .series-end {
    padding: 1.5rem;
    text-align: center;
    color: var(--text-muted);
  }
  .series-end p {
    margin: 0 0 0.75rem;
    font-size: 0.9rem;
  }
  .series-end-link {
    color: var(--accent);
    font-weight: 600;
    font-size: 0.9rem;
    text-decoration: none;
  }
  .series-end-link:hover {
    text-decoration: underline;
  }

  .copy-btn {
    cursor: pointer;
    border: 1px solid transparent;
    font-family: var(--font-mono);
    transition: border-color 0.15s;
  }
  .copy-btn:hover {
    border-color: var(--accent);
  }
  .copy-btn-label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 1.05rem;
  }

  @media (max-width: 640px) {
    .metrics-list {
      padding: 0.5rem;
      gap: 0.75rem;
    }

    .metric-panel-header {
      padding: 0.5rem 0.75rem;
    }

    .metric-panel-insight {
      padding: 0.5rem 0.75rem;
    }

    .detail-header h1 {
      font-size: 1.35rem;
    }
  }
</style>
