---
interface Props {
  spec: object;
}

const { spec } = Astro.props;
const chartId = `vega-${Math.random().toString(36).slice(2, 10)}`;
---

<div class="chart-container">
  <div id={chartId} style="width:100%;min-height:300px;"></div>
</div>

<script define:vars={{ spec, chartId }} is:inline>
  (function() {
    function render() {
      if (typeof vegaEmbed === 'undefined') {
        setTimeout(render, 100);
        return;
      }
      var el = document.getElementById(chartId);
      if (!el) return;
      var style = getComputedStyle(document.documentElement);
      var text = style.getPropertyValue('--text').trim();
      var textMuted = style.getPropertyValue('--text-muted').trim();
      var border = style.getPropertyValue('--border').trim();
      var accent = style.getPropertyValue('--accent').trim();
      var fontMono = style.getPropertyValue('--font-mono').trim();
      var patchedSpec = JSON.parse(JSON.stringify(spec));
      if (patchedSpec.encoding && patchedSpec.encoding.color) {
        patchedSpec.encoding.color.legend = Object.assign(
          patchedSpec.encoding.color.legend || {},
          { titleColor: text, labelColor: text, titleFont: fontMono, labelFont: fontMono }
        );
      }
      vegaEmbed(el, patchedSpec, {
        actions: false,
        renderer: 'svg',
        config: {
          background: 'transparent',
          font: fontMono,
          title: { color: text, font: fontMono, fontSize: 13, fontWeight: 600 },
          axis: {
            labelColor: text,
            titleColor: text,
            gridColor: border,
            domainColor: border,
            tickColor: border,
            labelFont: fontMono,
            titleFont: fontMono,
            labelFontSize: 11,
            titleFontSize: 12,
          },
          legend: {
            labelColor: text,
            titleColor: text,
            labelFont: fontMono,
            titleFont: fontMono,
            labelFontSize: 11,
            titleFontSize: 12,
          },
          bar: { color: accent },
          line: { color: accent },
          point: { color: accent },
          view: { stroke: 'transparent' },
          range: {
            category: [accent, '#a78bfa', '#2dd4bf', '#f472b6', '#fbbf24', '#34d399']
          },
        }
      }).catch(function(err) { el.textContent = 'Chart error: ' + err; });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', render);
    } else {
      render();
    }
  })();
</script>
