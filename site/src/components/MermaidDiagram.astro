---
interface Props {
  diagram: string;
  caption?: string;
}

const { diagram, caption } = Astro.props;
const chartId = `mermaid-${Math.random().toString(36).slice(2, 10)}`;
---

<div class="mermaid-wrapper" data-chart-id={chartId} data-mermaid-source={diagram}>
  <div class="mermaid-toolbar">
    <button class="mermaid-btn" data-action="zoom-out" title="Zoom out">&minus;</button>
    <span class="mermaid-zoom-label">100%</span>
    <button class="mermaid-btn" data-action="zoom-in" title="Zoom in">+</button>
    <button class="mermaid-btn" data-action="zoom-fit" title="Fit to width">Fit</button>
  </div>
  <div class="mermaid-container">
    <div class="mermaid-scroll-area">
      <div id={chartId} class="mermaid-render">
        <div class="mermaid-skeleton">
          <div class="skeleton-node"></div>
          <div class="skeleton-edge"></div>
          <div class="skeleton-node"></div>
        </div>
      </div>
    </div>
  </div>
  {caption && <p class="mermaid-caption">{caption}</p>}
</div>

<script define:vars={{ diagram, chartId }} is:inline>
  (function() {
    var ZOOM_STEPS = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2, 3];

    function render() {
      if (typeof window.mermaidLib === 'undefined') return;

      var el = document.getElementById(chartId);
      if (!el) return;

      if (!window.__mermaidInitialized) {
        var style = getComputedStyle(document.documentElement);
        var bg = style.getPropertyValue('--bg').trim();
        var bgCard = style.getPropertyValue('--bg-card').trim();
        var accent = style.getPropertyValue('--accent').trim();
        var text = style.getPropertyValue('--text').trim();
        var textMuted = style.getPropertyValue('--text-muted').trim();
        var fontMono = style.getPropertyValue('--font-mono').trim();

        window.mermaidLib.initialize({
          startOnLoad: false,
          theme: 'base',
          themeVariables: {
            darkMode: true,
            background: bg,
            primaryColor: bg,
            primaryTextColor: text,
            primaryBorderColor: accent,
            secondaryColor: bgCard,
            secondaryBorderColor: accent,
            secondaryTextColor: text,
            tertiaryColor: bg,
            tertiaryBorderColor: textMuted,
            tertiaryTextColor: text,
            lineColor: textMuted,
            nodeTextColor: text,
            clusterBkg: bgCard,
            clusterBorder: accent,
            edgeLabelBackground: bg,
            noteBkgColor: bgCard,
            noteTextColor: text,
            noteBorderColor: textMuted,
            fontFamily: fontMono,
            fontSize: '14px',
          },
          flowchart: { htmlLabels: true, curve: 'monotoneY', padding: 15 },
        });
        window.__mermaidInitialized = true;
      }

      try {
        window.mermaidLib.render(chartId + '-svg', diagram).then(function(result) {
          el.innerHTML = result.svg;
          initZoom(el);
        }).catch(function(err) {
          el.innerHTML = '<pre style="color:var(--text-muted);font-size:0.75rem;white-space:pre;overflow-x:auto">' +
            diagram.replace(/</g, '&lt;') + '</pre>';
        });
      } catch(err) {
        el.innerHTML = '<pre style="color:var(--text-muted);font-size:0.75rem;white-space:pre;overflow-x:auto">' +
          diagram.replace(/</g, '&lt;') + '</pre>';
      }
    }

    function initZoom(renderEl) {
      var wrapper = renderEl.closest('.mermaid-wrapper');
      if (!wrapper) return;

      var container = wrapper.querySelector('.mermaid-container');
      var scrollArea = wrapper.querySelector('.mermaid-scroll-area');
      var label = wrapper.querySelector('.mermaid-zoom-label');
      var svg = renderEl.querySelector('svg');
      if (!svg || !container || !scrollArea || !label) return;

      // Get natural SVG dimensions from viewBox or attributes
      var naturalW, naturalH;
      var vb = svg.getAttribute('viewBox');
      if (vb) {
        var parts = vb.split(/[\s,]+/);
        naturalW = parseFloat(parts[2]);
        naturalH = parseFloat(parts[3]);
      }
      if (!naturalW || !naturalH) {
        var wAttr = svg.getAttribute('width');
        var hAttr = svg.getAttribute('height');
        naturalW = parseFloat(wAttr) || svg.getBoundingClientRect().width;
        naturalH = parseFloat(hAttr) || svg.getBoundingClientRect().height;
      }
      if (!naturalW || !naturalH) return;

      // Fix SVG to natural pixel size (remove mermaid's width:100%)
      svg.style.width = naturalW + 'px';
      svg.style.height = naturalH + 'px';
      svg.style.maxWidth = 'none';
      svg.style.display = 'block';

      var currentScale = 1;

      function fitScale() {
        var containerW = container.clientWidth;
        return Math.min(1, containerW / naturalW);
      }

      function applyZoom(scale) {
        currentScale = scale;
        renderEl.style.transform = 'scale(' + scale + ')';
        renderEl.style.transformOrigin = '0 0';
        scrollArea.style.width = Math.ceil(naturalW * scale) + 'px';
        scrollArea.style.height = Math.ceil(naturalH * scale) + 'px';
        label.textContent = Math.round(scale * 100) + '%';
      }

      function findStepIndex(scale) {
        // Find closest step
        var closest = 0;
        var minDiff = Math.abs(ZOOM_STEPS[0] - scale);
        for (var i = 1; i < ZOOM_STEPS.length; i++) {
          var diff = Math.abs(ZOOM_STEPS[i] - scale);
          if (diff < minDiff) {
            minDiff = diff;
            closest = i;
          }
        }
        return closest;
      }

      // Wire up buttons
      var buttons = wrapper.querySelectorAll('.mermaid-btn');
      for (var i = 0; i < buttons.length; i++) {
        (function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            var action = btn.getAttribute('data-action');
            if (action === 'zoom-fit') {
              applyZoom(fitScale());
            } else if (action === 'zoom-in') {
              var idx = findStepIndex(currentScale);
              if (idx < ZOOM_STEPS.length - 1) {
                applyZoom(ZOOM_STEPS[idx + 1]);
              }
            } else if (action === 'zoom-out') {
              var idx = findStepIndex(currentScale);
              if (idx > 0) {
                applyZoom(ZOOM_STEPS[idx - 1]);
              }
            }
          });
        })(buttons[i]);
      }

      // Initial zoom: fit to container
      applyZoom(fitScale());

      // ResizeObserver: recalculate fit if user had "Fit" active
      if (typeof ResizeObserver !== 'undefined') {
        var lastFit = true;
        var origApplyZoom = applyZoom;
        applyZoom = function(scale) {
          lastFit = (Math.abs(scale - fitScale()) < 0.01);
          origApplyZoom(scale);
        };
        // Re-bind initial
        applyZoom(fitScale());

        new ResizeObserver(function() {
          if (lastFit) {
            origApplyZoom(fitScale());
          }
        }).observe(container);
      }
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
      window.__mermaidInitialized = false;
      render();
    });

    // Try immediately (mermaid may already be loaded)
    render();
    // Listen for the event if not yet available
    window.addEventListener('mermaid:ready', render);

    // Fallback: if mermaid never loads after 5s, show raw diagram text
    setTimeout(function() {
      var el = document.getElementById(chartId);
      if (el && !el.querySelector('svg')) {
        el.innerHTML = '<pre style="color:var(--text-muted);font-size:0.75rem;white-space:pre;overflow-x:auto">' +
          diagram.replace(/</g, '&lt;') + '</pre>';
      }
    }, 5000);
  })();
</script>

<style>
  .mermaid-wrapper {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .mermaid-toolbar {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.35rem 0.75rem;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    user-select: none;
  }

  .mermaid-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.6rem;
    height: 1.6rem;
    padding: 0 0.4rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    cursor: pointer;
    line-height: 1;
    transition: background 0.1s, border-color 0.1s;
  }

  .mermaid-btn:hover {
    background: var(--bg);
    border-color: var(--text-muted);
  }

  .mermaid-zoom-label {
    min-width: 2.5rem;
    text-align: center;
    color: var(--text-muted);
    font-variant-numeric: tabular-nums;
  }

  .mermaid-container {
    padding: 1.25rem;
    overflow: auto;
  }

  .mermaid-scroll-area {
    /* Dimensions set by JS to match scaled SVG */
    margin: 0 auto;
  }

  .mermaid-render {
    /* transform set by JS */
  }

  .mermaid-render :global(svg) {
    display: block;
  }

  @media (max-width: 640px) {
    .mermaid-container {
      position: relative;
      padding: 0.75rem;
    }

    .mermaid-container::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 2rem;
      height: 100%;
      background: linear-gradient(to right, transparent, var(--bg-card));
      pointer-events: none;
    }

    .mermaid-container {
      -webkit-overflow-scrolling: touch;
    }
  }

  .mermaid-caption {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0;
    padding: 0 1.25rem 0.75rem;
    font-style: italic;
  }

  .mermaid-skeleton {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    animation: skeleton-pulse 1.5s ease-in-out infinite;
  }

  .skeleton-node {
    width: 5rem;
    height: 2.5rem;
    border-radius: 6px;
    background: var(--bg-surface);
    border: 1px solid var(--border);
  }

  .skeleton-edge {
    width: 3rem;
    height: 2px;
    background: var(--border);
  }

  @keyframes skeleton-pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }
</style>
