---
# Azure Composition for Cache XRD
# Creates Azure Cache for Redis
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xcaches.azure.illm.io
  labels:
    provider: azure
    crossplane.io/xrd: xcaches.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XCache

  environment:
    environmentConfigs:
      - type: Reference
        ref:
          name: cluster-info

  resources:
    # Resource Group
    - name: resource-group
      base:
        apiVersion: azure.upbound.io/v1beta1
        kind: ResourceGroup
        spec:
          forProvider:
            location: eastus
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-cache-rg"

    # Azure Cache for Redis
    - name: redis-cache
      base:
        apiVersion: cache.azure.upbound.io/v1beta1
        kind: RedisCache
        spec:
          forProvider:
            location: eastus
            capacity: 0
            family: C
            skuName: Basic
            enableNonSslPort: false
            minimumTlsVersion: "1.2"
            resourceGroupNameSelector:
              matchControllerRef: true
          writeConnectionSecretToRef:
            namespace: crossplane-system
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.name

        # Size mapping
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.skuName
          transforms:
            - type: map
              map:
                small: Basic
                medium: Standard
                large: Premium
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.family
          transforms:
            - type: map
              map:
                small: C
                medium: C
                large: P
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.capacity
          transforms:
            - type: map
              map:
                small: 0
                medium: 1
                large: 1

        # High availability (replication)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.highAvailability
          toFieldPath: spec.forProvider.replicasPerMaster
          transforms:
            - type: map
              map:
                "true": 1
                "false": 0

        # Connection secret
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.writeConnectionSecretToRef.name
          transforms:
            - type: string
              string:
                fmt: "%s-cache-conn"

        # Status
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.hostname
          toFieldPath: status.endpoint
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.sslPort
          toFieldPath: status.port
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.cloud
          transforms:
            - type: string
              string:
                fmt: azure
