---
# AWS Composition for Database XRD
# Creates AWS RDS PostgreSQL/MySQL Instance
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xdatabases.aws.illm.io
  labels:
    provider: aws
    crossplane.io/xrd: xdatabases.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XDatabase

  # Use EnvironmentConfig for automatic cloud selection
  environment:
    environmentConfigs:
      - type: Reference
        ref:
          name: cluster-info

  patchSets:
    - name: common-tags
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.labels
          toFieldPath: spec.forProvider.tags
          policy:
            mergeOptions:
              keepMapValues: true

  resources:
    # DB Subnet Group
    - name: db-subnet-group
      base:
        apiVersion: rds.aws.upbound.io/v1beta1
        kind: SubnetGroup
        spec:
          forProvider:
            region: us-east-1
            description: "Crossplane managed subnet group for database"
            subnetIdSelector:
              matchLabels:
                access: private
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-subnet-group"

    # Security Group for RDS
    - name: security-group
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroup
        spec:
          forProvider:
            region: us-east-1
            description: "Security group for RDS database"
            vpcIdSelector:
              matchLabels:
                type: main
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-db-sg"

    # Security Group Rule - PostgreSQL
    - name: sg-rule-postgres
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        spec:
          forProvider:
            region: us-east-1
            type: ingress
            fromPort: 5432
            toPort: 5432
            protocol: tcp
            cidrBlocks:
              - "10.0.0.0/8"
            securityGroupIdSelector:
              matchControllerRef: true
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-sg-rule"
        # Adjust CIDR for public access
        - type: FromCompositeFieldPath
          fromFieldPath: spec.publicAccess
          toFieldPath: spec.forProvider.cidrBlocks[0]
          transforms:
            - type: map
              map:
                "true": "0.0.0.0/0"
                "false": "10.0.0.0/8"

    # RDS Instance
    - name: rds-instance
      base:
        apiVersion: rds.aws.upbound.io/v1beta1
        kind: Instance
        spec:
          forProvider:
            region: us-east-1
            allocatedStorage: 20
            autoMinorVersionUpgrade: true
            backupRetentionPeriod: 7
            engine: postgres
            engineVersion: "14"
            instanceClass: db.t3.micro
            publiclyAccessible: false
            skipFinalSnapshot: true
            storageEncrypted: true
            storageType: gp3
            username: dbadmin
            passwordSecretRef:
              key: password
              namespace: crossplane-system
            dbSubnetGroupNameSelector:
              matchControllerRef: true
            vpcSecurityGroupIdSelector:
              matchControllerRef: true
          writeConnectionSecretToRef:
            namespace: crossplane-system
      patches:
        # Name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.dbName

        # Engine
        - type: FromCompositeFieldPath
          fromFieldPath: spec.engine
          toFieldPath: spec.forProvider.engine
          transforms:
            - type: map
              map:
                postgresql: postgres
                mysql: mysql

        # Version
        - type: FromCompositeFieldPath
          fromFieldPath: spec.version
          toFieldPath: spec.forProvider.engineVersion

        # Size mapping: abstract size -> AWS instance class
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.instanceClass
          transforms:
            - type: map
              map:
                small: db.t3.micro
                medium: db.t3.medium
                large: db.r5.large

        # Storage
        - type: FromCompositeFieldPath
          fromFieldPath: spec.storageGB
          toFieldPath: spec.forProvider.allocatedStorage

        # Public access
        - type: FromCompositeFieldPath
          fromFieldPath: spec.publicAccess
          toFieldPath: spec.forProvider.publiclyAccessible

        # High availability
        - type: FromCompositeFieldPath
          fromFieldPath: spec.highAvailability
          toFieldPath: spec.forProvider.multiAz

        # Backup retention
        - type: FromCompositeFieldPath
          fromFieldPath: spec.backupRetentionDays
          toFieldPath: spec.forProvider.backupRetentionPeriod

        # Connection secret name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.writeConnectionSecretToRef.name
          transforms:
            - type: string
              string:
                fmt: "%s-db-conn"

        # Status: endpoint
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.endpoint
          toFieldPath: status.endpoint

        # Status: port
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.port
          toFieldPath: status.port

        # Status: cloud
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.cloud
          transforms:
            - type: string
              string:
                fmt: aws
