---
# Azure Composition for Queue XRD
# Creates Azure Service Bus Namespace and Queue
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xqueues.azure.illm.io
  labels:
    provider: azure
    crossplane.io/xrd: xqueues.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XQueue

  environment:
    environmentConfigs:
      - type: Reference
        ref:
          name: cluster-info

  resources:
    # Resource Group
    - name: resource-group
      base:
        apiVersion: azure.upbound.io/v1beta1
        kind: ResourceGroup
        spec:
          forProvider:
            location: eastus
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-queue-rg"

    # Service Bus Namespace
    - name: servicebus-namespace
      base:
        apiVersion: servicebus.azure.upbound.io/v1beta1
        kind: ServiceBusNamespace
        spec:
          forProvider:
            location: eastus
            sku: Basic
            resourceGroupNameSelector:
              matchControllerRef: true
          writeConnectionSecretToRef:
            namespace: crossplane-system
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-sb-ns"
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.name
          transforms:
            - type: string
              string:
                fmt: "%s-sb-ns"

        # Type affects SKU (FIFO requires Standard+)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.type
          toFieldPath: spec.forProvider.sku
          transforms:
            - type: map
              map:
                standard: Basic
                fifo: Standard

        # Connection secret
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.writeConnectionSecretToRef.name
          transforms:
            - type: string
              string:
                fmt: "%s-queue-conn"

        # Status: endpoint
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.endpoint
          toFieldPath: status.endpoint

        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.cloud
          transforms:
            - type: string
              string:
                fmt: azure

    # Service Bus Queue
    - name: servicebus-queue
      base:
        apiVersion: servicebus.azure.upbound.io/v1beta1
        kind: Queue
        spec:
          forProvider:
            maxDeliveryCount: 10
            enablePartitioning: false
            namespaceIdSelector:
              matchControllerRef: true
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.name

        # Message retention (days -> ISO 8601 duration)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.messageRetentionDays
          toFieldPath: spec.forProvider.defaultMessageTtl
          transforms:
            - type: string
              string:
                fmt: "P%dD"

        # Visibility timeout -> lock duration (seconds -> ISO 8601)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.visibilityTimeoutSeconds
          toFieldPath: spec.forProvider.lockDuration
          transforms:
            - type: string
              string:
                fmt: "PT%dS"

        # Dead letter queue
        - type: FromCompositeFieldPath
          fromFieldPath: spec.deadLetterQueue
          toFieldPath: spec.forProvider.deadLetteringOnMessageExpiration

        # FIFO -> requires sessions
        - type: FromCompositeFieldPath
          fromFieldPath: spec.type
          toFieldPath: spec.forProvider.requiresSession
          transforms:
            - type: map
              map:
                standard: false
                fifo: true

        # Status
        - type: ToCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.queueName
