---
# AWS Composition for Queue XRD
# Creates AWS SQS Queue
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xqueues.aws.illm.io
  labels:
    provider: aws
    crossplane.io/xrd: xqueues.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XQueue

  environment:
    environmentConfigs:
      - type: Reference
        ref:
          name: cluster-info

  resources:
    # SQS Queue
    - name: sqs-queue
      base:
        apiVersion: sqs.aws.upbound.io/v1beta1
        kind: Queue
        spec:
          forProvider:
            region: us-east-1
            messageRetentionSeconds: 345600  # 4 days default
            visibilityTimeoutSeconds: 30
            sqsManagedSseEnabled: true
          writeConnectionSecretToRef:
            namespace: crossplane-system
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.name

        # FIFO queue suffix
        - type: FromCompositeFieldPath
          fromFieldPath: spec.type
          toFieldPath: spec.forProvider.fifoQueue
          transforms:
            - type: map
              map:
                standard: false
                fifo: true

        # Message retention (days -> seconds)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.messageRetentionDays
          toFieldPath: spec.forProvider.messageRetentionSeconds
          transforms:
            - type: math
              math:
                multiply: 86400  # days to seconds

        # Visibility timeout
        - type: FromCompositeFieldPath
          fromFieldPath: spec.visibilityTimeoutSeconds
          toFieldPath: spec.forProvider.visibilityTimeoutSeconds

        # Encryption
        - type: FromCompositeFieldPath
          fromFieldPath: spec.encryption
          toFieldPath: spec.forProvider.sqsManagedSseEnabled

        # Connection secret
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.writeConnectionSecretToRef.name
          transforms:
            - type: string
              string:
                fmt: "%s-queue-conn"

        # Status
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.url
          toFieldPath: status.endpoint
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.name
          toFieldPath: status.queueName
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: status.cloud
          transforms:
            - type: string
              string:
                fmt: aws

    # Dead Letter Queue (if enabled)
    - name: dlq
      base:
        apiVersion: sqs.aws.upbound.io/v1beta1
        kind: Queue
        spec:
          forProvider:
            region: us-east-1
            messageRetentionSeconds: 1209600  # 14 days
            sqsManagedSseEnabled: true
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-dlq"
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.name
          transforms:
            - type: string
              string:
                fmt: "%s-dlq"
        # FIFO DLQ must also be FIFO
        - type: FromCompositeFieldPath
          fromFieldPath: spec.type
          toFieldPath: spec.forProvider.fifoQueue
          transforms:
            - type: map
              map:
                standard: false
                fifo: true
