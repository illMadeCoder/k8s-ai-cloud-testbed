---
# ExperimentCluster CompositeResourceDefinition
# Provides a unified API for experiment cluster provisioning across providers:
# - vcluster: Local ephemeral clusters (replaces Kind)
# - talos: Persistent hardware home lab
# - aks: Azure Kubernetes Service
# - eks: Amazon Elastic Kubernetes Service
#
# See ADR-012 for design decisions
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xexperimentclusters.illm.io
spec:
  group: illm.io
  names:
    kind: XExperimentCluster
    plural: xexperimentclusters
  claimNames:
    kind: ExperimentCluster
    plural: experimentclusters
  connectionSecretKeys:
    - kubeconfig
    - server
    - ca
    - token
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - provider
                - scenario
              properties:
                provider:
                  type: string
                  description: Infrastructure provider for the cluster
                  enum:
                    - vcluster
                    - talos
                    - aks
                    - eks
                    - gke
                scenario:
                  type: string
                  description: Experiment scenario name (e.g., otel-tutorial)
                  minLength: 1
                  maxLength: 63
                size:
                  type: string
                  description: Cluster size (maps to provider-specific resources)
                  enum:
                    - small
                    - medium
                    - large
                  default: small
                k8sVersion:
                  type: string
                  description: Kubernetes version (provider support varies)
                  default: "1.31"
                deployApps:
                  type: boolean
                  description: Whether to deploy ArgoCD apps from scenario directory
                  default: true
            status:
              type: object
              properties:
                clusterName:
                  type: string
                  description: Name of the cluster as registered in ArgoCD
                server:
                  type: string
                  description: Kubernetes API server URL
                phase:
                  type: string
                  description: Current lifecycle phase
                  enum:
                    - Pending
                    - Provisioning
                    - Ready
                    - Failed
                    - Deleting
                provider:
                  type: string
                  description: Provider that created this cluster
                message:
                  type: string
                  description: Human-readable status message
      additionalPrinterColumns:
        - name: Provider
          type: string
          jsonPath: .spec.provider
        - name: Scenario
          type: string
          jsonPath: .spec.scenario
        - name: Size
          type: string
          jsonPath: .spec.size
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Server
          type: string
          jsonPath: .status.server
          priority: 1
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
