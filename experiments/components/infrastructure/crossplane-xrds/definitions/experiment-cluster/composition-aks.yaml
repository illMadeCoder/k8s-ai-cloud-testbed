---
# AKS Composition for ExperimentCluster XRD
# Creates an Azure Kubernetes Service cluster for experiments
#
# Resources created:
# 1. Resource Group (exp-{scenario}-rg)
# 2. Virtual Network (exp-{scenario}-vnet)
# 3. Subnet (exp-{scenario}-subnet)
# 4. AKS Cluster (exp-{scenario})
#
# Connection secrets:
# - Kubeconfig written to crossplane-system/exp-{scenario}-kubeconfig
#   with key "kubeconfig" containing the full admin kubeconfig YAML
#
# ArgoCD Integration:
# ArgoCD registration requires extracting credentials from the kubeconfig.
# Use the following to register the cluster:
#   az aks get-credentials --resource-group exp-{scenario}-rg --name exp-{scenario} --admin
#   argocd cluster add exp-{scenario} --name aks-{scenario}
#
# Prerequisites:
# - Azure ProviderConfig named "default" with credentials
# - Subscription and tenant configured in ProviderConfig
# - provider-family-azure installed (provides ghost CRDs)
#
# MRAP Pattern:
# This composition includes ManagedResourceDefinitions that activate only the
# CRDs needed for AKS clusters. When the claim is deleted, MRDs are deleted,
# and the controllers deactivate - saving memory on the hub cluster.
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xexperimentclusters.aks.illm.io
  labels:
    provider: aks
    crossplane.io/xrd: xexperimentclusters.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XExperimentCluster

  writeConnectionSecretsToNamespace: crossplane-system

  patchSets:
    - name: metadata
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.labels
          toFieldPath: metadata.labels
          policy:
            mergeOptions:
              keepMapValues: true
    - name: common-tags
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.tags["illm.io/scenario"]
        - type: FromCompositeFieldPath
          fromFieldPath: spec.provider
          toFieldPath: spec.forProvider.tags["illm.io/provider"]

  resources:
    # ============================================================
    # MRAP: ManagedResourceDefinitions for CRD Activation
    # These activate controllers only when this composition is used
    # ============================================================

    # MRD: Azure base resources (ResourceGroup)
    - name: mrd-azure-resources
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: kubernetes-incluster
          forProvider:
            manifest:
              apiVersion: pkg.crossplane.io/v1alpha1
              kind: ManagedResourceDefinition
              metadata:
                name: placeholder
                labels:
                  illm.io/experiment: "true"
              spec:
                providerRef:
                  name: provider-family-azure
                resources:
                  - group: azure.upbound.io
                    kinds:
                      - ResourceGroup
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.manifest.metadata.name
          transforms:
            - type: string
              string:
                fmt: "mrd-%s-azure-resources"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.manifest.metadata.labels["illm.io/scenario"]

    # MRD: Azure network resources (VirtualNetwork, Subnet)
    - name: mrd-azure-network
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: kubernetes-incluster
          forProvider:
            manifest:
              apiVersion: pkg.crossplane.io/v1alpha1
              kind: ManagedResourceDefinition
              metadata:
                name: placeholder
                labels:
                  illm.io/experiment: "true"
              spec:
                providerRef:
                  name: provider-family-azure
                resources:
                  - group: network.azure.upbound.io
                    kinds:
                      - VirtualNetwork
                      - Subnet
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.manifest.metadata.name
          transforms:
            - type: string
              string:
                fmt: "mrd-%s-azure-network"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.manifest.metadata.labels["illm.io/scenario"]

    # MRD: Azure container service (KubernetesCluster, KubernetesClusterNodePool)
    - name: mrd-azure-containerservice
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: kubernetes-incluster
          forProvider:
            manifest:
              apiVersion: pkg.crossplane.io/v1alpha1
              kind: ManagedResourceDefinition
              metadata:
                name: placeholder
                labels:
                  illm.io/experiment: "true"
              spec:
                providerRef:
                  name: provider-family-azure
                resources:
                  - group: containerservice.azure.upbound.io
                    kinds:
                      - KubernetesCluster
                      - KubernetesClusterNodePool
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.manifest.metadata.name
          transforms:
            - type: string
              string:
                fmt: "mrd-%s-azure-containerservice"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.manifest.metadata.labels["illm.io/scenario"]

    # ============================================================
    # Azure Resources (created after MRDs activate controllers)
    # ============================================================

    # 1. Resource Group
    - name: resource-group
      base:
        apiVersion: azure.upbound.io/v1beta1
        kind: ResourceGroup
        spec:
          forProvider:
            location: eastus
            tags:
              illm.io/experiment: "true"
              illm.io/managed-by: crossplane
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-rg"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-rg"
        - patchSetName: common-tags
          type: PatchSet

    # 2. Virtual Network
    - name: vnet
      base:
        apiVersion: network.azure.upbound.io/v1beta1
        kind: VirtualNetwork
        spec:
          forProvider:
            location: eastus
            addressSpace:
              - "10.0.0.0/16"
            resourceGroupNameSelector:
              matchControllerRef: true
            tags:
              illm.io/experiment: "true"
              illm.io/managed-by: crossplane
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-vnet"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-vnet"
        - patchSetName: common-tags
          type: PatchSet

    # 3. Subnet for AKS nodes
    - name: subnet
      base:
        apiVersion: network.azure.upbound.io/v1beta1
        kind: Subnet
        spec:
          forProvider:
            addressPrefixes:
              - "10.0.0.0/20"
            resourceGroupNameSelector:
              matchControllerRef: true
            virtualNetworkNameSelector:
              matchControllerRef: true
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-subnet"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-subnet"

    # 4. AKS Cluster
    - name: aks-cluster
      base:
        apiVersion: containerservice.azure.upbound.io/v1beta1
        kind: KubernetesCluster
        spec:
          forProvider:
            location: eastus
            resourceGroupNameSelector:
              matchControllerRef: true
            dnsPrefix: placeholder
            kubernetesVersion: "1.31"
            # Default node pool
            defaultNodePool:
              - name: default
                vmSize: Standard_D2s_v3
                nodeCount: 2
                vnetSubnetIdSelector:
                  matchControllerRef: true
                temporaryNameForRotation: tmppool
            # Identity (system-assigned)
            identity:
              - type: SystemAssigned
            # Network profile
            networkProfile:
              - networkPlugin: azure
                networkPolicy: azure
                serviceCidr: "10.1.0.0/16"
                dnsServiceIp: "10.1.0.10"
            # SKU for dev/test
            skuTier: Free
            tags:
              illm.io/experiment: "true"
              illm.io/managed-by: crossplane
          writeConnectionSecretToRef:
            namespace: crossplane-system
      patches:
        # Cluster name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s"
        # DNS prefix (must be unique)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.forProvider.dnsPrefix
          transforms:
            - type: string
              string:
                fmt: "exp-%s"
        # Kubernetes version
        - type: FromCompositeFieldPath
          fromFieldPath: spec.k8sVersion
          toFieldPath: spec.forProvider.kubernetesVersion
        # Connection secret name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: spec.writeConnectionSecretToRef.name
          transforms:
            - type: string
              string:
                fmt: "exp-%s-kubeconfig"
        # Size mapping: VM size
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.defaultNodePool[0].vmSize
          transforms:
            - type: map
              map:
                small: Standard_D2s_v3
                medium: Standard_D4s_v3
                large: Standard_D8s_v3
        # Size mapping: Node count
        - type: FromCompositeFieldPath
          fromFieldPath: spec.size
          toFieldPath: spec.forProvider.defaultNodePool[0].nodeCount
          transforms:
            - type: map
              map:
                small: 2
                medium: 3
                large: 5
        # Status: Write API server FQDN to status
        - type: ToCompositeFieldPath
          fromFieldPath: status.atProvider.fqdn
          toFieldPath: status.server
          transforms:
            - type: string
              string:
                fmt: "https://%s:443"
        # Status: Write cluster name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.scenario
          toFieldPath: status.clusterName
          transforms:
            - type: string
              string:
                fmt: "aks-%s"
        # Status: Write provider
        - type: FromCompositeFieldPath
          fromFieldPath: spec.provider
          toFieldPath: status.provider
        - patchSetName: common-tags
          type: PatchSet

  # Connection secrets propagation
  # The AKS cluster writes its kubeconfig to crossplane-system namespace
  # This can be used for:
  # - Direct kubectl access
  # - Crossplane provider-kubernetes ProviderConfig
  # - Manual ArgoCD registration
  #
  # Note: ArgoCD cluster secret creation is intentionally not included here
  # because AKS kubeconfig format requires transformation. Options:
  # 1. Use 'argocd cluster add' CLI after provisioning
  # 2. Create a Crossplane function to transform kubeconfig
  # 3. Use ExternalSecrets with transformation template
