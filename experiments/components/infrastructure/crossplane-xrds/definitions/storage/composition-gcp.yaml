---
# GCP Composition for ObjectStorage XRD
# Creates GCS Bucket (versioning, encryption, public access are inline properties)
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: xobjectstorages.gcp.illm.io
  labels:
    provider: gcp
    crossplane.io/xrd: xobjectstorages.illm.io
spec:
  compositeTypeRef:
    apiVersion: illm.io/v1alpha1
    kind: XObjectStorage

  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          # GCS Bucket
          - name: gcs-bucket
            base:
              apiVersion: storage.gcp.upbound.io/v1beta1
              kind: Bucket
              spec:
                forProvider:
                  location: US
                  storageClass: STANDARD
                  uniformBucketLevelAccess: true
                  publicAccessPrevention: enforced
                  forceDestroy: true   # Lab use â€” easy cleanup
                writeConnectionSecretToRef:
                  namespace: crossplane-system
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: metadata.annotations[crossplane.io/external-name]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "illm-%s"

              # Versioning
              - type: FromCompositeFieldPath
                fromFieldPath: spec.versioning
                toFieldPath: spec.forProvider.versioning[0].enabled

              # Public access
              - type: FromCompositeFieldPath
                fromFieldPath: spec.publicAccess
                toFieldPath: spec.forProvider.publicAccessPrevention
                transforms:
                  - type: convert
                    convert:
                      toType: string
                  - type: map
                    map:
                      "true": inherited
                      "false": enforced

              # Connection secret
              - type: FromCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: spec.writeConnectionSecretToRef.name
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s-storage-conn"

              # Status
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.url
                toFieldPath: status.endpoint
              - type: ToCompositeFieldPath
                fromFieldPath: status.atProvider.id
                toFieldPath: status.bucketName
              - type: ToCompositeFieldPath
                fromFieldPath: metadata.name
                toFieldPath: status.cloud
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "gcp%.0s"

    - step: auto-ready
      functionRef:
        name: function-auto-ready
