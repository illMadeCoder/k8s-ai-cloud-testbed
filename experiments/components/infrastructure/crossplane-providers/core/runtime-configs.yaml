---
# DeploymentRuntimeConfigs for installed providers
#
# Architecture (Upbound provider families):
# - Family providers (provider-family-{cloud}) run controllers
# - Individual providers (provider-{cloud}-{service}) only install CRDs
# - CRD-only providers need 1 replica for conversion webhooks
#
# Memory notes:
# - OOM at 256Mi caused cluster instability (provider OOM â†’ API server auth errors)
# - Using 512Mi limit with 256Mi request for headroom
---
# GCP storage provider (CRD-only, 1 replica for conversion webhooks)
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: gcp-storage-crd-only
spec:
  deploymentTemplate:
    spec:
      replicas: 1
      selector:
        matchLabels:
          pkg.crossplane.io/provider: provider-gcp-storage
      template:
        metadata:
          labels:
            pkg.crossplane.io/provider: provider-gcp-storage
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: package-runtime
              resources:
                requests:
                  cpu: 10m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
---
# Helm provider
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: helm-runtime-config
spec:
  deploymentTemplate:
    spec:
      selector:
        matchLabels:
          pkg.crossplane.io/provider: provider-helm
      template:
        metadata:
          labels:
            pkg.crossplane.io/provider: provider-helm
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: package-runtime
              resources:
                requests:
                  cpu: 50m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 384Mi
---
# Kubernetes provider
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: kubernetes-runtime-config
spec:
  deploymentTemplate:
    spec:
      selector:
        matchLabels:
          pkg.crossplane.io/provider: provider-kubernetes
      template:
        metadata:
          labels:
            pkg.crossplane.io/provider: provider-kubernetes
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: package-runtime
              resources:
                requests:
                  cpu: 50m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 384Mi
---
# GCP family provider (controller for all GCP resources)
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: gcp-family-config
spec:
  deploymentTemplate:
    spec:
      selector:
        matchLabels:
          pkg.crossplane.io/family: provider-family-gcp
      template:
        metadata:
          labels:
            pkg.crossplane.io/family: provider-family-gcp
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          securityContext:
            fsGroup: 65532
          containers:
            - name: package-runtime
              resources:
                requests:
                  cpu: 50m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
---
# GCP container provider (CRD-only for GKE)
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: gcp-container-crd-only
spec:
  deploymentTemplate:
    spec:
      replicas: 1
      selector:
        matchLabels:
          pkg.crossplane.io/provider: provider-gcp-container
      template:
        metadata:
          labels:
            pkg.crossplane.io/provider: provider-gcp-container
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: package-runtime
              resources:
                requests:
                  cpu: 10m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
---
# GCP compute provider (CRD-only for VPC/networking)
# Note: Compute provider has many CRDs and needs more memory than storage/container
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: gcp-compute-crd-only
spec:
  deploymentTemplate:
    spec:
      replicas: 1
      selector:
        matchLabels:
          pkg.crossplane.io/provider: provider-gcp-compute
      template:
        metadata:
          labels:
            pkg.crossplane.io/provider: provider-gcp-compute
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: package-runtime
              resources:
                requests:
                  cpu: 50m
                  memory: 256Mi
                limits:
                  cpu: 200m
                  memory: 512Mi
