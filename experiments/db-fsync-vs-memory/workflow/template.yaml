apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: db-fsync-vs-memory-validation
  namespace: argo-workflows
  labels:
    app.kubernetes.io/managed-by: experiment-operator
spec:
  entrypoint: validate-and-observe
  serviceAccountName: argo-workflow
  arguments:
    parameters:
      - name: experiment-name
        value: ""
      - name: target-endpoint
        value: ""
      - name: target-name
        value: ""
  templates:
    - name: validate-and-observe
      steps:
        - - name: smoke-test
            template: check-target
        - - name: wait-for-stacks
            template: wait-for-stacks
        - - name: observe
            template: observe

    - name: check-target
      container:
        image: curlimages/curl:8.5.0
        command: [sh, -c]
        args:
          - |
            echo "=== Smoke-testing target cluster ==="
            for i in $(seq 1 30); do
              if curl -sk "https://{{workflow.parameters.target-endpoint}}/livez" 2>/dev/null; then
                echo "Target cluster reachable"
                exit 0
              fi
              echo "Attempt $i/30 â€” retrying in 10s..."
              sleep 10
            done
            echo "Target cluster not reachable after 5 minutes"
            exit 1

    - name: wait-for-stacks
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            echo "=== Waiting for ArgoCD to sync components ==="
            echo "naive-db-fsync + naive-db-nosync StatefulSets + PVCs + kube-prometheus-stack"
            echo "db-benchmark-loadgen Job runs on target alongside both databases"
            for i in $(seq 1 10); do
              echo "Wait $i/10 (30s intervals)..."
              sleep 30
            done
            echo "Stack sync wait complete"

    - name: observe
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            echo "=== Observation window (25 min) ==="
            echo "Benchmark loadgen Job runs 7 phases against both variants."
            echo "Prometheus scrapes naivedb_* metrics every 15s via ServiceMonitors."
            echo "Waiting for benchmark to complete and metrics to settle..."
            sleep 1500
            echo "Observation complete"
