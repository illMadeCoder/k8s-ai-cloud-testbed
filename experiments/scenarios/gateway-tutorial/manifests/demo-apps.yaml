# Gateway Tutorial Demo Apps
# Multiple services for demonstrating routing patterns
#
# Services:
# - echo-v1, echo-v2: For traffic splitting demos
# - api-service: httpbin for API routing demos
# - web-service: nginx for basic web routing
---
apiVersion: v1
kind: Namespace
metadata:
  name: gateway-tutorial
---
# Echo Service V1 - Returns version identifier
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-v1
  namespace: gateway-tutorial
  labels:
    app: echo
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo
      version: v1
  template:
    metadata:
      labels:
        app: echo
        version: v1
    spec:
      containers:
        - name: echo
          image: hashicorp/http-echo:1.0
          args:
            - "-text=Hello from echo-v1"
            - "-listen=:8080"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
          ports:
            - containerPort: 8080
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
---
apiVersion: v1
kind: Service
metadata:
  name: echo-v1
  namespace: gateway-tutorial
  labels:
    app: echo
    version: v1
spec:
  selector:
    app: echo
    version: v1
  ports:
    - port: 80
      targetPort: 8080
---
# Echo Service V2 - Returns version identifier (for canary/traffic splitting)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-v2
  namespace: gateway-tutorial
  labels:
    app: echo
    version: v2
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo
      version: v2
  template:
    metadata:
      labels:
        app: echo
        version: v2
    spec:
      containers:
        - name: echo
          image: hashicorp/http-echo:1.0
          args:
            - "-text=Hello from echo-v2"
            - "-listen=:8080"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
          ports:
            - containerPort: 8080
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
---
apiVersion: v1
kind: Service
metadata:
  name: echo-v2
  namespace: gateway-tutorial
  labels:
    app: echo
    version: v2
spec:
  selector:
    app: echo
    version: v2
  ports:
    - port: 80
      targetPort: 8080
---
# API Service - httpbin for API routing demonstrations
# Provides /get, /post, /headers, /status/:code, /delay/:seconds, etc.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-service
  namespace: gateway-tutorial
  labels:
    app: api-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: api-service
  template:
    metadata:
      labels:
        app: api-service
    spec:
      containers:
        - name: httpbin
          image: kong/httpbin:0.1.0
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
          ports:
            - containerPort: 80
          resources:
            requests:
              cpu: 20m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          livenessProbe:
            httpGet:
              path: /status/200
              port: 80
            initialDelaySeconds: 5
          readinessProbe:
            httpGet:
              path: /status/200
              port: 80
            initialDelaySeconds: 3
---
apiVersion: v1
kind: Service
metadata:
  name: api-service
  namespace: gateway-tutorial
  labels:
    app: api-service
spec:
  selector:
    app: api-service
  ports:
    - port: 80
      targetPort: 80
---
# Web Service - nginx serving static content
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-content
  namespace: gateway-tutorial
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head><title>Gateway Tutorial - Web Service</title></head>
    <body>
      <h1>Gateway Tutorial Web Service</h1>
      <p>This is the web-service backend for gateway routing demos.</p>
      <ul>
        <li><a href="/api/">/api/</a> - API service (httpbin)</li>
        <li><a href="/echo/">/echo/</a> - Echo service</li>
      </ul>
    </body>
    </html>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-service
  namespace: gateway-tutorial
  labels:
    app: web-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: web-service
  template:
    metadata:
      labels:
        app: web-service
    spec:
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
              add: [NET_BIND_SERVICE]
            runAsNonRoot: true
            runAsUser: 101
            seccompProfile:
              type: RuntimeDefault
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: web-content
              mountPath: /usr/share/nginx/html
            - name: nginx-config
              mountPath: /etc/nginx/conf.d
            - name: nginx-cache
              mountPath: /var/cache/nginx
            - name: nginx-run
              mountPath: /var/run
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
      volumes:
        - name: web-content
          configMap:
            name: web-content
        - name: nginx-config
          configMap:
            name: nginx-nonroot-config
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-run
          emptyDir: {}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-nonroot-config
  namespace: gateway-tutorial
data:
  default.conf: |
    server {
        listen 8080;
        server_name localhost;
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: web-service
  namespace: gateway-tutorial
  labels:
    app: web-service
spec:
  selector:
    app: web-service
  ports:
    - port: 80
      targetPort: 8080
---
# Slow Service - For timeout/retry demonstrations
# Uses httpbin's /delay endpoint wrapped in a service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: slow-service
  namespace: gateway-tutorial
  labels:
    app: slow-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: slow-service
  template:
    metadata:
      labels:
        app: slow-service
    spec:
      containers:
        - name: httpbin
          image: kong/httpbin:0.1.0
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
            runAsNonRoot: true
            runAsUser: 1000
            seccompProfile:
              type: RuntimeDefault
          ports:
            - containerPort: 80
          resources:
            requests:
              cpu: 20m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: slow-service
  namespace: gateway-tutorial
  labels:
    app: slow-service
  annotations:
    description: "Use /delay/N endpoint for timeout demos"
spec:
  selector:
    app: slow-service
  ports:
    - port: 80
      targetPort: 80
