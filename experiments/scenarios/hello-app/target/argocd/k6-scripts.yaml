# k6 Scripts ConfigMap for Hello App Experiment
apiVersion: v1
kind: ConfigMap
metadata:
  name: hello-app-k6-scripts
  namespace: argo-workflows
data:
  test.js: |
    // Hello App Load Test
    // Simple smoke test for the custom hello-app

    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    const errorRate = new Rate('errors');

    export const options = {
      vus: __ENV.USERS ? parseInt(__ENV.USERS) : 5,
      duration: __ENV.DURATION || '30s',

      thresholds: {
        http_req_duration: ['p(95)<300'],
        errors: ['rate<0.05'],
      },
    };

    const BASE_URL = __ENV.TARGET_URL || 'http://hello-app.hello-app.svc:80';

    export default function () {
      // 80% root, 20% health
      if (Math.random() < 0.8) {
        const res = http.get(`${BASE_URL}/`);
        const success = check(res, {
          'root status 200': (r) => r.status === 200,
          'has message': (r) => r.json('message') !== undefined,
        });
        errorRate.add(!success);
      } else {
        const res = http.get(`${BASE_URL}/health`);
        const success = check(res, {
          'health status 200': (r) => r.status === 200,
        });
        errorRate.add(!success);
      }

      sleep(0.5 + Math.random());
    }

    export function handleSummary(data) {
      const metrics = data.metrics;
      return {
        'stdout': `
    === Hello App Test Results ===

    Requests: ${metrics.http_reqs?.values?.count || 0}
    Rate: ${(metrics.http_reqs?.values?.rate || 0).toFixed(2)}/s
    Avg Latency: ${(metrics.http_req_duration?.values?.avg || 0).toFixed(2)}ms
    P95 Latency: ${(metrics.http_req_duration?.values?.['p(95)'] || 0).toFixed(2)}ms
    Error Rate: ${((metrics.errors?.values?.rate || 0) * 100).toFixed(2)}%
    Status: ${Object.entries(data.thresholds || {}).every(([k,v]) => v.ok) ? 'PASSED' : 'FAILED'}
    `,
      };
    }
