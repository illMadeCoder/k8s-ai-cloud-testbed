apiVersion: experiments.illm.io/v1alpha1
kind: Experiment
metadata:
  generateName: db-baseline-fsync-
  namespace: experiments
spec:
  description: "Baseline: naive fsync-per-write store on GKE PD-SSD â€” measures the floor cost of durable 4-byte sequential writes with no WAL, no batching, no optimization"
  tags: ["baseline", "storage", "database"]
  publish: true

  analyzerConfig:
    sections:
      - abstract
      - targetAnalysis
      - performanceAnalysis
      - metricInsights
      - finopsAnalysis
      - body
      - feedback
      - architectureDiagram

  hypothesis:
    claim: "A naive fsync-per-write store on GKE PD-SSD achieves <5ms p99 write latency for sequential 4-byte writes, establishing the floor cost of durable persistence"
    questions:
      - "What is the true fsync cost on GKE PD-SSD for single-row durable writes?"
      - "How does read latency compare to write latency when reads are served from page cache?"
      - "What sustained write throughput is achievable with fsync-per-write serialization?"
    focus:
      - "fsync latency distribution on cloud block storage"
      - "write throughput ceiling under serialized I/O"
      - "page cache hit rate for sequential reads"

  targets:
    - name: app
      cluster:
        type: gke
        machineType: e2-standard-4
        preemptible: true
      observability:
        enabled: true
        transport: tailscale
      components:
        - app: naive-db
        - app: kube-prometheus-stack
        - app: metrics-agent
        - app: metrics-egress

  metrics:
    - name: write_p99_latency
      query: "histogram_quantile(0.99, sum(rate(naivedb_write_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[$DURATION])) by (le))"
      type: instant
      unit: seconds
      description: "P99 write latency including fsync"
      group: latency

    - name: write_p50_latency
      query: "histogram_quantile(0.5, sum(rate(naivedb_write_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[$DURATION])) by (le))"
      type: instant
      unit: seconds
      description: "P50 write latency including fsync"
      group: latency

    - name: fsync_p99_latency
      query: "histogram_quantile(0.99, sum(rate(naivedb_fsync_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[$DURATION])) by (le))"
      type: instant
      unit: seconds
      description: "P99 fsync-only latency"
      group: latency

    - name: fsync_p50_latency
      query: "histogram_quantile(0.5, sum(rate(naivedb_fsync_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[$DURATION])) by (le))"
      type: instant
      unit: seconds
      description: "P50 fsync-only latency"
      group: latency

    - name: read_p99_latency
      query: "histogram_quantile(0.99, sum(rate(naivedb_read_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[$DURATION])) by (le))"
      type: instant
      unit: seconds
      description: "P99 read latency (page cache)"
      group: latency

    - name: write_throughput
      query: "sum(rate(naivedb_operations_total{op=\"write\", namespace=~\"$EXPERIMENT\"}[$DURATION]))"
      type: instant
      unit: ops/s
      description: "Write operations per second"
      group: throughput

    - name: read_throughput
      query: "sum(rate(naivedb_operations_total{op=\"read\", namespace=~\"$EXPERIMENT\"}[$DURATION]))"
      type: instant
      unit: ops/s
      description: "Read operations per second"
      group: throughput

    - name: total_rows
      query: "naivedb_rows_total{namespace=~\"$EXPERIMENT\"}"
      type: instant
      unit: rows
      description: "Total rows written"
      group: throughput

    - name: write_latency_over_time
      query: "histogram_quantile(0.99, sum(rate(naivedb_write_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[1m])) by (le))"
      type: range
      unit: seconds
      description: "P99 write latency over time"
      group: latency

    - name: fsync_latency_over_time
      query: "histogram_quantile(0.99, sum(rate(naivedb_fsync_duration_seconds_bucket{namespace=~\"$EXPERIMENT\"}[1m])) by (le))"
      type: range
      unit: seconds
      description: "P99 fsync latency over time"
      group: latency

  workflow:
    template: db-baseline-fsync-validation
    completion:
      mode: workflow
