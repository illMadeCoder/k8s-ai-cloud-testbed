apiVersion: experiments.illm.io/v1alpha1
kind: Experiment
metadata:
  generateName: tsdb-comparison-
  namespace: experiments
spec:
  description: "TSDB comparison v2 - Prometheus vs VictoriaMetrics vs Mimir resource efficiency under identical workload"
  tags: ["comparison", "observability", "metrics"]
  publish: true

  analyzerConfig:
    sections:
      - abstract
      - targetAnalysis
      - performanceAnalysis
      - metricInsights
      - finopsAnalysis
      - secopsAnalysis
      - body
      - capabilitiesMatrix
      - feedback
      - architectureDiagram

  hypothesis:
    claim: "VictoriaMetrics will be the most resource-efficient for single-node deployments because its merge-tree storage engine and single-binary architecture avoid the per-component overhead of distributed systems, while Mimir's monolithic mode will require higher base resources due to its object-storage dependency (MinIO) and embedded microservices architecture"
    questions:
      - "What is the steady-state CPU and memory footprint of each TSDB under identical 1k-series ingestion workload?"
      - "How do resource usage patterns differ over a 90-minute window (approaching Prometheus block rotation)?"
      - "What is the operational footprint (pod count, component count) of each architecture?"
      - "What are the resource trade-offs between Prometheus' local TSDB, VM's merge-tree engine, and Mimir's monolithic-on-object-storage design?"
    focus:
      - "per-TSDB resource efficiency"
      - "memory and CPU patterns over time"
      - "operational complexity"
      - "architecture trade-offs"

  targets:
    - name: app
      cluster:
        type: gke
        machineType: e2-standard-4
        preemptible: true
      observability:
        enabled: true
        transport: tailscale
      components:
        - app: kube-prometheus-stack
          params:
            grafana.enabled: "true"
            prometheus.prometheusSpec.retention: "24h"
            alertmanager.enabled: "false"
            # Remote write to Mimir so it receives metrics
            prometheus.prometheusSpec.remoteWrite[0].url: "http://mimir-gateway.mimir.svc:80/api/v1/push"
            prometheus.prometheusSpec.remoteWrite[0].headers.X-Scope-OrgID: "anonymous"
            # Resources for larger node
            prometheus.prometheusSpec.resources.requests.cpu: "100m"
            prometheus.prometheusSpec.resources.requests.memory: "256Mi"
            prometheus.prometheusSpec.resources.limits.cpu: "1"
            prometheus.prometheusSpec.resources.limits.memory: "1Gi"
            # Discover all ServiceMonitors
            prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues: "false"
            prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues: "false"
            # Disable unnecessary components
            nodeExporter.enabled: "false"
            defaultRules.create: "false"
            kubeApiServer.enabled: "false"
            kubelet.enabled: "false"
            kubeControllerManager.enabled: "false"
            coreDns.enabled: "false"
            kubeEtcd.enabled: "false"
            kubeScheduler.enabled: "false"
            kubeProxy.enabled: "false"
            prometheusOperator.tls.enabled: "false"
            prometheusOperator.admissionWebhooks.enabled: "false"
        - app: victoria-metrics
        - app: mimir
        - app: minio
          params:
            buckets[0].name: "mimir-blocks"
            buckets[0].policy: "none"
            buckets[0].purge: "false"
            buckets[1].name: "mimir-ruler"
            buckets[1].policy: "none"
            buckets[1].purge: "false"
            buckets[2].name: "mimir-alertmanager"
            buckets[2].policy: "none"
            buckets[2].purge: "false"
        - app: cardinality-generator

  metrics:
    # Per-TSDB CPU (by pod within each namespace)
    - name: prometheus_stack_cpu
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",namespace="monitoring",container!="POD",container!=""}[5m])) by (pod)'
      type: range
      unit: cores
      description: "Prometheus stack CPU by pod"
    - name: victoria_metrics_cpu
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",namespace="victoria-metrics",container!="POD",container!=""}[5m])) by (pod)'
      type: range
      unit: cores
      description: "VictoriaMetrics CPU by pod"
    - name: mimir_cpu
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",namespace="mimir",container!="POD",container!=""}[5m])) by (pod)'
      type: range
      unit: cores
      description: "Mimir CPU by pod"
    # Per-TSDB Memory
    - name: prometheus_stack_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",namespace="monitoring",container!="POD",container!=""}) by (pod)'
      type: range
      unit: bytes
      description: "Prometheus stack memory by pod"
    - name: victoria_metrics_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",namespace="victoria-metrics",container!="POD",container!=""}) by (pod)'
      type: range
      unit: bytes
      description: "VictoriaMetrics memory by pod"
    - name: mimir_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",namespace="mimir",container!="POD",container!=""}) by (pod)'
      type: range
      unit: bytes
      description: "Mimir memory by pod"
    # Infrastructure
    - name: infra_cpu
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",namespace=~"minio|tsdb-comparison",container!="POD",container!=""}[5m])) by (pod)'
      type: range
      unit: cores
      description: "Infrastructure CPU (MinIO + cardinality-generator)"
    - name: infra_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",namespace=~"minio|tsdb-comparison",container!="POD",container!=""}) by (pod)'
      type: range
      unit: bytes
      description: "Infrastructure memory (MinIO + cardinality-generator)"
    # Cluster totals
    - name: cluster_cpu
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",container!="POD",container!=""}[5m]))'
      type: range
      unit: cores
      description: "Total cluster CPU"
    - name: cluster_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",container!="POD",container!=""})'
      type: range
      unit: bytes
      description: "Total cluster memory"

  workflow:
    template: tsdb-comparison-validation
    completion:
      mode: workflow
