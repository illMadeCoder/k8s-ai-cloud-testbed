# Part 5: Advanced gRPC Features
# gRPC-Web, Transcoding, Security, Observability
---
# Part 5g: gRPC-Web Configuration
# Enables browser clients to call gRPC services
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: grpc-web-config
  namespace: grpc-tutorial
spec:
  # Enable gRPC-Web transcoding filter
  # This allows browsers to call gRPC services via gRPC-Web protocol
  provider:
    type: Kubernetes
---
# gRPC-Web route (requires special handling)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: grpc-web-route
  namespace: grpc-tutorial
  annotations:
    description: |
      gRPC-Web transcoding for browser clients.
      Browser sends: application/grpc-web
      Gateway converts to: application/grpc
spec:
  parentRefs:
    - name: grpc-gateway
      sectionName: grpcs
  hostnames:
    - "grpc-web.gateway.local"
  rules:
    - matches:
        - headers:
            - name: content-type
              value: application/grpc-web
        - headers:
            - name: content-type
              value: application/grpc-web+proto
      backendRefs:
        - name: grpc-echo
          port: 50051
      filters:
        - type: ResponseHeaderModifier
          responseHeaderModifier:
            add:
              # CORS headers for browser
              - name: Access-Control-Allow-Origin
                value: "*"
              - name: Access-Control-Allow-Methods
                value: "POST, OPTIONS"
              - name: Access-Control-Allow-Headers
                value: "content-type, x-grpc-web, x-user-agent"
              - name: Access-Control-Expose-Headers
                value: "grpc-status, grpc-message"
---
# Part 5h: gRPC-JSON Transcoding
# REST clients can call gRPC services
# Requires google.api.http annotations in proto files
apiVersion: v1
kind: ConfigMap
metadata:
  name: grpc-transcoding-example
  namespace: grpc-tutorial
data:
  example.proto: |
    syntax = "proto3";
    package example;

    import "google/api/annotations.proto";

    service UserService {
      // gRPC method with HTTP transcoding
      rpc GetUser(GetUserRequest) returns (User) {
        option (google.api.http) = {
          get: "/v1/users/{user_id}"
        };
      }

      rpc CreateUser(CreateUserRequest) returns (User) {
        option (google.api.http) = {
          post: "/v1/users"
          body: "*"
        };
      }

      rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) {
        option (google.api.http) = {
          get: "/v1/users"
        };
      }
    }

    message GetUserRequest {
      string user_id = 1;
    }

    message CreateUserRequest {
      string name = 1;
      string email = 2;
    }

    message User {
      string id = 1;
      string name = 2;
      string email = 3;
    }

    message ListUsersRequest {
      int32 page_size = 1;
      string page_token = 2;
    }

    message ListUsersResponse {
      repeated User users = 1;
      string next_page_token = 2;
    }
  usage.md: |
    # gRPC-JSON Transcoding Usage

    With transcoding enabled, REST clients can call gRPC services:

    ```bash
    # REST call (transcoded to gRPC)
    curl https://api.gateway.local/v1/users/123

    # Equivalent gRPC call
    grpcurl -d '{"user_id": "123"}' api.gateway.local:443 example.UserService/GetUser
    ```

    Both return the same response!
---
# Part 5i: gRPC Security Configuration
# TLS modes and authentication
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: grpc-secure-gateway
  namespace: grpc-tutorial
spec:
  gatewayClassName: eg
  listeners:
    # mTLS listener for mutual TLS
    - name: grpc-mtls
      protocol: HTTPS
      port: 8443
      tls:
        mode: Terminate
        certificateRefs:
          - name: server-cert
        options:
          gateway.envoyproxy.io/client-validation: "required"
      allowedRoutes:
        kinds:
          - kind: GRPCRoute
---
# Server TLS certificate (for mTLS gateway)
#
# DEMO CERTIFICATE - DO NOT USE IN PRODUCTION
# In production, use cert-manager or ExternalSecrets with a secret store.
#
# To regenerate:
#   openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes \
#     -keyout server.key -out server.crt \
#     -subj "/CN=grpc.gateway.local" \
#     -addext "subjectAltName=DNS:grpc.gateway.local,DNS:*.grpc.gateway.local"
#
apiVersion: v1
kind: Secret
metadata:
  name: server-cert
  namespace: grpc-tutorial
  annotations:
    description: "Demo server TLS certificate for gRPC tutorial"
type: kubernetes.io/tls
stringData:
  # Using same cert as gateway tutorial for simplicity
  tls.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDQDCCAiigAwIBAgIUUfjOVcj0vDU/Gw6Emo5fmNDNdjIwDQYJKoZIhvcNAQEL
    BQAwGjEYMBYGA1UEAwwPKi5nYXRld2F5LmxvY2FsMB4XDTI2MDExNTE4MTQ1NFoX
    DTI3MDExNTE4MTQ1NFowGjEYMBYGA1UEAwwPKi5nYXRld2F5LmxvY2FsMIIBIjAN
    BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt5yIeGc9i7UQno5QAAia7QhdLxlm
    VloXHzblT1L5l7xFPOqp4JYaHCcEfV831FgHNrh25+VuK9p65rXHZ6Fik+J8xVSZ
    ZFBl1fYaWi4wDbDvJXXjrheUm4xxJueUxzMbMgeO/JTE0W/SPNJvuj3hezEph9aj
    nXL9EyRqF6j/ZdFqxbMQ4olz9ildwHtMyAkJMwYfAI32c/cQuke/P7vaNouP+7mk
    C2oGjiU7MgEHqAprY3tabbPRXN1di2YxfHf9GnVKut3e37lr0OXnJ2oq13UF/LAc
    ekSoc0TgihxKmI45bKmmedyhUQxB2Fel2l8mNNSxnEVb2TDxqOR7LEK4/wIDAQAB
    o34wfDAdBgNVHQ4EFgQUA2pME/m6ezjMYuMjCDCrs3udDbkwHwYDVR0jBBgwFoAU
    A2pME/m6ezjMYuMjCDCrs3udDbkwDwYDVR0TAQH/BAUwAwEB/zApBgNVHREEIjAg
    gg8qLmdhdGV3YXkubG9jYWyCDWdhdGV3YXkubG9jYWwwDQYJKoZIhvcNAQELBQAD
    ggEBAAHXzJpQu9o65sQaIc8oqzv60wPSzBQmltQvCinCoXK4mMKGaekobrc9LOWR
    Ztz51U9EkkdfMNfSDu/fdt+2MwvcjUVepv4FCXEOYtHv1veVZaJ3vGWO3W1sOkWP
    CHCW9CTNt3oBGVeRqqzRCjRog3vh1q+TAZbza0i/6SPYl2N5IdLCxAhja7/cTMbU
    O3bTwaPh6La/fKjT9vHB6teBUbVn3lLwEGeXvTE7Nf+pEYxZpMSphHdb4jWkM2pq
    9SGWtTUznK1kyephmQa5iMk9Q2FcyQwF/QziVwlgjaeTm+mzzit4qDTWN7YD++20
    PEp8NTloylSE4K/mbdv4RAdfGt0=
    -----END CERTIFICATE-----
  tls.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC3nIh4Zz2LtRCe
    jlAACJrtCF0vGWZWWhcfNuVPUvmXvEU86qnglhocJwR9XzfUWAc2uHbn5W4r2nrm
    tcdnoWKT4nzFVJlkUGXV9hpaLjANsO8ldeOuF5SbjHEm55THMxsyB478lMTRb9I8
    0m+6PeF7MSmH1qOdcv0TJGoXqP9l0WrFsxDiiXP2KV3Ae0zICQkzBh8AjfZz9xC6
    R78/u9o2i4/7uaQLagaOJTsyAQeoCmtje1pts9Fc3V2LZjF8d/0adUq63d7fuWvQ
    5ecnairXdQX8sBx6RKhzROCKHEqYjjlsqaZ53KFRDEHYV6XaXyY01LGcRVvZMPGo
    5HssQrj/AgMBAAECggEAHqd6G0v1OQVmPGp7Db5iCy/Jyuq9LK6GzLXQC/HI7N3I
    W3a8HNxCiK+07q9+dSurLKYYZ/fkcFreCPWRUIpfmFwIQ7OvllFb5yBa3vJ2IFsJ
    WiI3/GFAdMW6QGoKa0VrhWtAooe94k9+dJwXfisFoZkgG2co0skXWmJKeh/DX/6Q
    xH/i3OL9YlhQS84Tfm6W3X1KuSZiCKZSJAMXNX7zIfOllIb91/0VGZKTaV9ufZbf
    IlZ/CXeZlt4yCecvOZI6BD1mNPDt8c11tb/fcNeIHp7fnkgvMN4VlBqC7tw9jKKz
    R6JXvx/VywKV3AK65/duvqvyPx3sOCf4NvC9xyxyxQKBgQD9WU4fbPL452iT+ygE
    6lyOrHnmg0NoyNXzpRBh5Eu16PNKIg0HzWiZ0oMjm+XTEreFzSkl28dh8EgS9Kpv
    YEN8dlnG0YYQLK3BLlb9wFt3jxghvjW1Wq5LXQhHQBqTAr5iZMCKYg9ljVUDJxup
    HGsjUfBD7feOLh6UxH42RJmOywKBgQC5iGinpYgzvDoHaGgP5lQoui58lpTA0FuN
    i5O7Qng1+GM1FQf6r2/Me3BfoJ2B4xNnRdH07jveBfTh9FQbGGR58ERnLvtAPYkc
    MC3nFMstUZTdGrJhk7ly7Hh+oYsJg2R47nCd/qjXUvq8rwtqrj7pjnKOb3eGPCEz
    HmDw8jskHQKBgQD8ErpHTEioXN7RtiiIU4MKNhQHxfzxKjqudELLk7G86m3/Ccg7
    RiZYPntal8fg7pOJXqsdTwKfsMqVibh2nqonET6cMmaYe0valTfavGSFneudzzpz
    GimnNIaDFgYa1bUGA0cLqSu2mBvIykWcSnlTKDjN7dzNK5gj3ynQ5wp+ZwKBgFS1
    RSMV3sPQMqZjMu/fd5lIuCTGE5CdEM/lZEPhK0Vo7NK1kXkRVHgF+96NVJyS8q76
    H8w2YTsTeSUZCrV8Q5Ow8Woy9x/zeIBYNv0Eb2d3kgIJSFxouAkSkkkutG5ZgSv9
    oYlhVfFJv5UaTpociDjWgtMpbWbqWTYfrp8T2ZC5AoGAKT3pIWpVohUwdlt9bWA2
    mMZ6zF1knomF/2BMiGIiWcFehlrEatngbTlsvqfQFX7/rgIQM72vTX881ebkAOSV
    rKcIidqXuwApUKhmIRaO08GkblYl1+MBNRrAvYvUkvj/q0vmV1HeH9jiuY0Defcx
    NyPEdsClXekZHx65yI+Jquc=
    -----END PRIVATE KEY-----
---
# Client CA certificate (for mTLS client validation)
#
# DEMO CERTIFICATE - DO NOT USE IN PRODUCTION
# In production, use cert-manager or ExternalSecrets with a secret store.
#
apiVersion: v1
kind: Secret
metadata:
  name: client-ca-cert
  namespace: grpc-tutorial
  annotations:
    description: "Demo client CA certificate for mTLS validation"
type: Opaque
stringData:
  # Using same cert as gateway tutorial for simplicity
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDQDCCAiigAwIBAgIUUfjOVcj0vDU/Gw6Emo5fmNDNdjIwDQYJKoZIhvcNAQEL
    BQAwGjEYMBYGA1UEAwwPKi5nYXRld2F5LmxvY2FsMB4XDTI2MDExNTE4MTQ1NFoX
    DTI3MDExNTE4MTQ1NFowGjEYMBYGA1UEAwwPKi5nYXRld2F5LmxvY2FsMIIBIjAN
    BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt5yIeGc9i7UQno5QAAia7QhdLxlm
    VloXHzblT1L5l7xFPOqp4JYaHCcEfV831FgHNrh25+VuK9p65rXHZ6Fik+J8xVSZ
    ZFBl1fYaWi4wDbDvJXXjrheUm4xxJueUxzMbMgeO/JTE0W/SPNJvuj3hezEph9aj
    nXL9EyRqF6j/ZdFqxbMQ4olz9ildwHtMyAkJMwYfAI32c/cQuke/P7vaNouP+7mk
    C2oGjiU7MgEHqAprY3tabbPRXN1di2YxfHf9GnVKut3e37lr0OXnJ2oq13UF/LAc
    ekSoc0TgihxKmI45bKmmedyhUQxB2Fel2l8mNNSxnEVb2TDxqOR7LEK4/wIDAQAB
    o34wfDAdBgNVHQ4EFgQUA2pME/m6ezjMYuMjCDCrs3udDbkwHwYDVR0jBBgwFoAU
    A2pME/m6ezjMYuMjCDCrs3udDbkwDwYDVR0TAQH/BAUwAwEB/zApBgNVHREEIjAg
    gg8qLmdhdGV3YXkubG9jYWyCDWdhdGV3YXkubG9jYWwwDQYJKoZIhvcNAQELBQAD
    ggEBAAHXzJpQu9o65sQaIc8oqzv60wPSzBQmltQvCinCoXK4mMKGaekobrc9LOWR
    Ztz51U9EkkdfMNfSDu/fdt+2MwvcjUVepv4FCXEOYtHv1veVZaJ3vGWO3W1sOkWP
    CHCW9CTNt3oBGVeRqqzRCjRog3vh1q+TAZbza0i/6SPYl2N5IdLCxAhja7/cTMbU
    O3bTwaPh6La/fKjT9vHB6teBUbVn3lLwEGeXvTE7Nf+pEYxZpMSphHdb4jWkM2pq
    9SGWtTUznK1kyephmQa5iMk9Q2FcyQwF/QziVwlgjaeTm+mzzit4qDTWN7YD++20
    PEp8NTloylSE4K/mbdv4RAdfGt0=
    -----END CERTIFICATE-----
---
# JWT Authentication for gRPC
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: grpc-jwt-auth
  namespace: grpc-tutorial
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: GRPCRoute
    name: grpc-authenticated
  jwt:
    providers:
      - name: auth0
        issuer: "https://your-tenant.auth0.com/"
        audiences:
          - "grpc-api"
        remoteJWKS:
          uri: "https://your-tenant.auth0.com/.well-known/jwks.json"
        claimToHeaders:
          - claim: sub
            header: x-user-id
          - claim: scope
            header: x-user-scope
---
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: grpc-authenticated
  namespace: grpc-tutorial
spec:
  parentRefs:
    - name: grpc-secure-gateway
  rules:
    - backendRefs:
        - name: grpc-echo
          port: 50051
---
# Part 5j: gRPC Observability
# Metrics and tracing configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: grpc-observability-config
  namespace: grpc-tutorial
data:
  metrics.md: |
    # gRPC Observability Metrics

    ## Key Metrics to Monitor

    ### Request Rate
    - `grpc_server_started_total` - Total RPCs started
    - `grpc_server_handled_total` - Total RPCs completed

    ### Error Rate
    - `grpc_server_handled_total{grpc_code!="OK"}` - Failed RPCs
    - Group by: grpc_code, grpc_service, grpc_method

    ### Latency
    - `grpc_server_handling_seconds` - RPC latency histogram
    - `grpc_server_handling_seconds_bucket{le="0.1"}` - % under 100ms

    ## PromQL Examples

    ```promql
    # Request rate by service
    sum(rate(grpc_server_started_total[5m])) by (grpc_service)

    # Error rate
    sum(rate(grpc_server_handled_total{grpc_code!="OK"}[5m]))
    /
    sum(rate(grpc_server_handled_total[5m]))

    # p95 latency
    histogram_quantile(0.95,
      sum(rate(grpc_server_handling_seconds_bucket[5m])) by (le, grpc_method)
    )
    ```

  tracing.md: |
    # gRPC Distributed Tracing

    ## Trace Context Propagation

    gRPC uses metadata (HTTP/2 headers) for trace context:
    - `traceparent` - W3C Trace Context
    - `grpc-trace-bin` - Legacy gRPC format

    ## OpenTelemetry Integration

    ```go
    // Go example
    import "go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc"

    conn, err := grpc.Dial(target,
      grpc.WithUnaryInterceptor(otelgrpc.UnaryClientInterceptor()),
      grpc.WithStreamInterceptor(otelgrpc.StreamClientInterceptor()),
    )
    ```

    ## Envoy Gateway Tracing

    Gateway automatically:
    - Generates trace IDs if not present
    - Propagates context to backends
    - Reports spans to configured backend (Zipkin, Jaeger, OTLP)
---
# Part 5k: gRPC Reflection and Debugging
apiVersion: v1
kind: ConfigMap
metadata:
  name: grpc-debugging
  namespace: grpc-tutorial
data:
  tools.md: |
    # gRPC Debugging Tools

    ## grpcurl - curl for gRPC
    ```bash
    # List services (requires reflection)
    grpcurl -plaintext localhost:50051 list

    # Describe service
    grpcurl -plaintext localhost:50051 describe grpc.Echo

    # Call method
    grpcurl -plaintext -d '{"message":"hello"}' \
      localhost:50051 grpc.Echo/Echo

    # With TLS
    grpcurl -cacert ca.crt \
      grpc.gateway.local:443 grpc.Echo/Echo

    # With headers (metadata)
    grpcurl -H 'x-version: v2' \
      localhost:50051 grpc.Echo/Echo
    ```

    ## grpc_cli (official tool)
    ```bash
    grpc_cli call localhost:50051 grpc.Echo.Echo "message: 'hello'"
    ```

    ## Evans - interactive gRPC client
    ```bash
    evans --host localhost --port 50051 -r repl
    > package grpc
    > service Echo
    > call Echo
    ```

    ## Postman
    - File > New > gRPC Request
    - Enter server URL
    - Import .proto or use reflection
    - Build request and send

    ## BloomRPC (GUI)
    - Import .proto files
    - Visual request builder
    - Response formatting

  reflection-security.md: |
    # gRPC Reflection Security

    ## What is Reflection?
    - Service discovery at runtime
    - Allows tools to query available methods
    - Like Swagger/OpenAPI for gRPC

    ## Security Considerations

    ### Development
    - Enable reflection for debugging
    - Useful for grpcurl, Evans, etc.

    ### Production
    - Consider disabling in prod
    - Exposes API surface to attackers
    - Alternative: Require authentication for reflection

    ### Conditional Enabling
    ```go
    if os.Getenv("ENABLE_REFLECTION") == "true" {
      reflection.Register(server)
    }
    ```

    ### Gateway-Level Control
    Block reflection methods at gateway:
    ```yaml
    # Block reflection service
    - matches:
        - method:
            service: grpc.reflection.v1alpha.ServerReflection
      filters:
        - type: RequestRedirect
          requestRedirect:
            statusCode: 404
    ```
