# Part 4: TLS Configuration and Multi-Gateway Patterns
---
# Part 4k: TLS Certificate for Gateway
#
# DEMO CERTIFICATE - DO NOT USE IN PRODUCTION
# In production, use cert-manager or ExternalSecrets with a secret store.
#
# To regenerate:
#   openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes \
#     -keyout tls.key -out tls.crt \
#     -subj "/CN=*.gateway.local" \
#     -addext "subjectAltName=DNS:*.gateway.local,DNS:gateway.local"
#
apiVersion: v1
kind: Secret
metadata:
  name: tutorial-tls-cert
  namespace: gateway-tutorial
  annotations:
    description: "Demo TLS certificate for tutorial - *.gateway.local"
type: kubernetes.io/tls
stringData:
  tls.crt: |
    -----BEGIN CERTIFICATE-----
    MIIDQDCCAiigAwIBAgIUUfjOVcj0vDU/Gw6Emo5fmNDNdjIwDQYJKoZIhvcNAQEL
    BQAwGjEYMBYGA1UEAwwPKi5nYXRld2F5LmxvY2FsMB4XDTI2MDExNTE4MTQ1NFoX
    DTI3MDExNTE4MTQ1NFowGjEYMBYGA1UEAwwPKi5nYXRld2F5LmxvY2FsMIIBIjAN
    BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt5yIeGc9i7UQno5QAAia7QhdLxlm
    VloXHzblT1L5l7xFPOqp4JYaHCcEfV831FgHNrh25+VuK9p65rXHZ6Fik+J8xVSZ
    ZFBl1fYaWi4wDbDvJXXjrheUm4xxJueUxzMbMgeO/JTE0W/SPNJvuj3hezEph9aj
    nXL9EyRqF6j/ZdFqxbMQ4olz9ildwHtMyAkJMwYfAI32c/cQuke/P7vaNouP+7mk
    C2oGjiU7MgEHqAprY3tabbPRXN1di2YxfHf9GnVKut3e37lr0OXnJ2oq13UF/LAc
    ekSoc0TgihxKmI45bKmmedyhUQxB2Fel2l8mNNSxnEVb2TDxqOR7LEK4/wIDAQAB
    o34wfDAdBgNVHQ4EFgQUA2pME/m6ezjMYuMjCDCrs3udDbkwHwYDVR0jBBgwFoAU
    A2pME/m6ezjMYuMjCDCrs3udDbkwDwYDVR0TAQH/BAUwAwEB/zApBgNVHREEIjAg
    gg8qLmdhdGV3YXkubG9jYWyCDWdhdGV3YXkubG9jYWwwDQYJKoZIhvcNAQELBQAD
    ggEBAAHXzJpQu9o65sQaIc8oqzv60wPSzBQmltQvCinCoXK4mMKGaekobrc9LOWR
    Ztz51U9EkkdfMNfSDu/fdt+2MwvcjUVepv4FCXEOYtHv1veVZaJ3vGWO3W1sOkWP
    CHCW9CTNt3oBGVeRqqzRCjRog3vh1q+TAZbza0i/6SPYl2N5IdLCxAhja7/cTMbU
    O3bTwaPh6La/fKjT9vHB6teBUbVn3lLwEGeXvTE7Nf+pEYxZpMSphHdb4jWkM2pq
    9SGWtTUznK1kyephmQa5iMk9Q2FcyQwF/QziVwlgjaeTm+mzzit4qDTWN7YD++20
    PEp8NTloylSE4K/mbdv4RAdfGt0=
    -----END CERTIFICATE-----
  tls.key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC3nIh4Zz2LtRCe
    jlAACJrtCF0vGWZWWhcfNuVPUvmXvEU86qnglhocJwR9XzfUWAc2uHbn5W4r2nrm
    tcdnoWKT4nzFVJlkUGXV9hpaLjANsO8ldeOuF5SbjHEm55THMxsyB478lMTRb9I8
    0m+6PeF7MSmH1qOdcv0TJGoXqP9l0WrFsxDiiXP2KV3Ae0zICQkzBh8AjfZz9xC6
    R78/u9o2i4/7uaQLagaOJTsyAQeoCmtje1pts9Fc3V2LZjF8d/0adUq63d7fuWvQ
    5ecnairXdQX8sBx6RKhzROCKHEqYjjlsqaZ53KFRDEHYV6XaXyY01LGcRVvZMPGo
    5HssQrj/AgMBAAECggEAHqd6G0v1OQVmPGp7Db5iCy/Jyuq9LK6GzLXQC/HI7N3I
    W3a8HNxCiK+07q9+dSurLKYYZ/fkcFreCPWRUIpfmFwIQ7OvllFb5yBa3vJ2IFsJ
    WiI3/GFAdMW6QGoKa0VrhWtAooe94k9+dJwXfisFoZkgG2co0skXWmJKeh/DX/6Q
    xH/i3OL9YlhQS84Tfm6W3X1KuSZiCKZSJAMXNX7zIfOllIb91/0VGZKTaV9ufZbf
    IlZ/CXeZlt4yCecvOZI6BD1mNPDt8c11tb/fcNeIHp7fnkgvMN4VlBqC7tw9jKKz
    R6JXvx/VywKV3AK65/duvqvyPx3sOCf4NvC9xyxyxQKBgQD9WU4fbPL452iT+ygE
    6lyOrHnmg0NoyNXzpRBh5Eu16PNKIg0HzWiZ0oMjm+XTEreFzSkl28dh8EgS9Kpv
    YEN8dlnG0YYQLK3BLlb9wFt3jxghvjW1Wq5LXQhHQBqTAr5iZMCKYg9ljVUDJxup
    HGsjUfBD7feOLh6UxH42RJmOywKBgQC5iGinpYgzvDoHaGgP5lQoui58lpTA0FuN
    i5O7Qng1+GM1FQf6r2/Me3BfoJ2B4xNnRdH07jveBfTh9FQbGGR58ERnLvtAPYkc
    MC3nFMstUZTdGrJhk7ly7Hh+oYsJg2R47nCd/qjXUvq8rwtqrj7pjnKOb3eGPCEz
    HmDw8jskHQKBgQD8ErpHTEioXN7RtiiIU4MKNhQHxfzxKjqudELLk7G86m3/Ccg7
    RiZYPntal8fg7pOJXqsdTwKfsMqVibh2nqonET6cMmaYe0valTfavGSFneudzzpz
    GimnNIaDFgYa1bUGA0cLqSu2mBvIykWcSnlTKDjN7dzNK5gj3ynQ5wp+ZwKBgFS1
    RSMV3sPQMqZjMu/fd5lIuCTGE5CdEM/lZEPhK0Vo7NK1kXkRVHgF+96NVJyS8q76
    H8w2YTsTeSUZCrV8Q5Ow8Woy9x/zeIBYNv0Eb2d3kgIJSFxouAkSkkkutG5ZgSv9
    oYlhVfFJv5UaTpociDjWgtMpbWbqWTYfrp8T2ZC5AoGAKT3pIWpVohUwdlt9bWA2
    mMZ6zF1knomF/2BMiGIiWcFehlrEatngbTlsvqfQFX7/rgIQM72vTX881ebkAOSV
    rKcIidqXuwApUKhmIRaO08GkblYl1+MBNRrAvYvUkvj/q0vmV1HeH9jiuY0Defcx
    NyPEdsClXekZHx65yI+Jquc=
    -----END PRIVATE KEY-----
---
# Part 4l: TLS Termination - Gateway terminates TLS
# This is the most common pattern
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-termination-gateway
  namespace: gateway-tutorial
spec:
  gatewayClassName: eg
  listeners:
    - name: https
      protocol: HTTPS
      port: 443
      tls:
        mode: Terminate
        certificateRefs:
          - name: tutorial-tls-cert
      allowedRoutes:
        namespaces:
          from: Same
---
# Part 4m: TLS Passthrough - Gateway passes encrypted traffic to backend
# Backend must handle TLS termination
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: tls-passthrough-gateway
  namespace: gateway-tutorial
spec:
  gatewayClassName: eg
  listeners:
    - name: tls-passthrough
      protocol: TLS
      port: 8443
      tls:
        mode: Passthrough
      allowedRoutes:
        namespaces:
          from: Same
---
# TLSRoute for passthrough (routes based on SNI)
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TLSRoute
metadata:
  name: tls-passthrough-route
  namespace: gateway-tutorial
spec:
  parentRefs:
    - name: tls-passthrough-gateway
      sectionName: tls-passthrough
  hostnames:
    - "passthrough.gateway.local"
  rules:
    - backendRefs:
        - name: api-service
          port: 80
---
# Part 4n: Multi-Gateway Pattern - Internal vs External
# External gateway for public traffic
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: external-gateway
  namespace: gateway-tutorial
  annotations:
    description: "Public-facing gateway with stricter security"
spec:
  gatewayClassName: eg
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
---
# Internal gateway for service-to-service traffic
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: internal-gateway
  namespace: gateway-tutorial
  annotations:
    description: "Internal gateway for cluster traffic"
spec:
  gatewayClassName: eg
  listeners:
    - name: http
      protocol: HTTP
      port: 8080
      allowedRoutes:
        namespaces:
          from: All  # Allow routes from any namespace
---
# Part 4o: ReferenceGrant - Cross-namespace routing
# Allow routes in other namespaces to reference services in gateway-tutorial
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-cross-namespace
  namespace: gateway-tutorial
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: other-namespace  # Allow routes from other-namespace
  to:
    - group: ""
      kind: Service
---
# Route attached to external gateway
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: external-api
  namespace: gateway-tutorial
spec:
  parentRefs:
    - name: external-gateway
  hostnames:
    - "api.public.gateway.local"
  rules:
    - backendRefs:
        - name: api-service
          port: 80
---
# Route attached to internal gateway
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: internal-api
  namespace: gateway-tutorial
spec:
  parentRefs:
    - name: internal-gateway
  hostnames:
    - "api.internal.gateway.local"
  rules:
    - backendRefs:
        - name: api-service
          port: 80
