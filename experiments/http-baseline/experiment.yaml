# HTTP Baseline Experiment
# Simple load test against demo-app to establish baseline metrics
apiVersion: experiments.illm.io/v1alpha1
kind: Experiment
metadata:
  name: http-baseline
  labels:
    category: performance
    tier: basic
  annotations:
    description: Establish baseline HTTP performance metrics for demo-app
    author: illm
    version: "1.0.0"

spec:
  # Environment targeting
  environments:
    supported:
      - minikube
      - proxmox
      - baremetal
      - cloud
    default: minikube
    settings:
      minikube:
        resourceMultiplier: 0.5
        timeout: 15m
      proxmox:
        resourceMultiplier: 1.0
        timeout: 30m

  # Infrastructure provisioning
  provision:
    enabled: false
    terraform:
      module: minikube
      # Root terraform config in experiments/http-baseline/terraform/

  # ArgoCD app-of-apps for this experiment
  # Defines which manifests from /manifests/ to deploy
  argocd:
    appOfApps: argocd/app-of-apps.yaml
    waitFor:
      - kind: Deployment
        name: demo-app
        namespace: demo-app
        condition: Available
      - kind: Deployment
        name: locust-master
        namespace: locust
        condition: Available

  # Kubernetes deployment (legacy - use argocd section instead)
  deploy:
    manifestRefs:
      - path: manifests/demo-app
      - path: manifests/observability
      - path: manifests/locust
      - path: manifests/minio
      - path: manifests/argo-workflows

  # Experiment execution
  execute:
    phases:
      - name: warmup
        description: Warm up the application
        duration: 30s
        load:
          enabled: true
          users: 5
          spawnRate: 1
          host: http://demo-app.demo-app.svc:8080
        chaos:
          enabled: false

      - name: baseline
        description: Establish baseline metrics under moderate load
        duration: 120s
        load:
          enabled: true
          users: 20
          spawnRate: 5
          host: http://demo-app.demo-app.svc:8080
        chaos:
          enabled: false

      - name: stress
        description: Test behavior under higher load
        duration: 60s
        load:
          enabled: true
          users: 50
          spawnRate: 10
          host: http://demo-app.demo-app.svc:8080
        chaos:
          enabled: false

    settings:
      continueOnFailure: false
      parallelPhases: false

  # Metrics collection
  collect:
    prometheus:
      enabled: true
      queries:
        - name: request_rate
          query: rate(http_requests_total[1m])
        - name: p95_latency
          query: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[1m]))
        - name: error_rate
          query: rate(http_requests_total{status=~"5.."}[1m])

    artifacts:
      destination: minio
      bucket: experiments
      path: http-baseline/${run_id}/
      retention: 30d

  # Teardown configuration
  teardown:
    scope:
      deleteNamespaces: false
      destroyInfrastructure: false

  # Success criteria
  successCriteria:
    - name: low-error-rate
      description: Error rate should be below 1%
      query: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) < 0.01

    - name: acceptable-latency
      description: P95 latency should be under 500ms
      query: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) < 0.5
