apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: db-storage-tiers-validation
  namespace: argo-workflows
  labels:
    app.kubernetes.io/managed-by: experiment-operator
spec:
  entrypoint: validate-and-observe
  serviceAccountName: argo-workflow
  arguments:
    parameters:
      - name: experiment-name
        value: ""
      - name: target-endpoint
        value: ""
      - name: target-name
        value: ""
  templates:
    - name: validate-and-observe
      steps:
        - - name: smoke-test
            template: check-target
        - - name: wait-for-stacks
            template: wait-for-stacks
        - - name: observe
            template: observe

    - name: check-target
      container:
        image: curlimages/curl:8.5.0
        command: [sh, -c]
        args:
          - |
            echo "=== Smoke-testing target cluster ==="
            for i in $(seq 1 30); do
              if curl -sk "https://{{workflow.parameters.target-endpoint}}/livez" 2>/dev/null; then
                echo "Target cluster reachable"
                exit 0
              fi
              echo "Attempt $i/30 â€” retrying in 10s..."
              sleep 10
            done
            echo "Target cluster not reachable after 5 minutes"
            exit 1

    - name: wait-for-stacks
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            echo "=== Waiting for ArgoCD to sync 8 naive-db variants + loadgen ==="
            echo "8 StatefulSets with 1Gi/10Gi PVCs across 4 StorageClasses + kube-prometheus-stack"
            echo "Hyperdisk Balanced PVC provisioning may take extra time..."
            for i in $(seq 1 40); do
              echo "Wait $i/40 (30s intervals = 20 min)..."
              sleep 30
            done
            echo "Stack sync wait complete"

    - name: observe
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            echo "=== Observation window (40 min) ==="
            echo "LoadGen runs sustained 60s write bursts against 8 variants (~8 min),"
            echo "plus reads and mixed OLTP (~8 min), plus 3 min cooldown = ~19 min."
            echo "Allowing 40 min total for benchmark completion and metric settlement."
            sleep 2400
            echo "Observation complete"
