apiVersion: experiments.illm.io/v1alpha1
kind: Experiment
metadata:
  generateName: gw-comp-
  namespace: experiments
spec:
  title: "API Gateway Shootout: NGINX vs Traefik vs Envoy"
  description: "Gateway comparison v2 — NGINX Ingress vs Traefik vs Envoy Gateway with load testing, per-gateway resource profiling, and latency benchmarks"
  tags: ["comparison", "networking", "gateway"]
  publish: true

  analyzerConfig:
    sections:
      - abstract
      - targetAnalysis
      - performanceAnalysis
      - metricInsights
      - finopsAnalysis
      - secopsAnalysis
      - body
      - capabilitiesMatrix
      - feedback
      - architectureDiagram
      - vocabulary

  hypothesis:
    claim: "Under load, Envoy Gateway's two-process architecture (separate control plane + Envoy data-plane proxy) will consume more total resources than NGINX Ingress's single-process model, but deliver lower tail latency because Envoy's event-driven C++ proxy handles concurrent connections more efficiently than NGINX's worker-process model"
    questions:
      - "What is the idle CPU/memory footprint of each gateway controller and data plane?"
      - "How do per-gateway resource profiles change from idle to loaded (50 concurrent users)?"
      - "What are the p50/p90/p99 latency distributions per gateway under sustained load?"
      - "Which gateway achieves the highest throughput ceiling before error rates increase?"
      - "How does Envoy Gateway's data-plane proxy (envoy-default-*) contribute to total resource usage?"
    focus:
      - "resource efficiency under load"
      - "latency percentiles (p50/p90/p99)"
      - "throughput and error rates"
      - "idle-vs-loaded resource delta"

  # Custom metrics — per-gateway CPU/memory rates, peaks, and drill-down
  # These activate after Phase 2 operator change (CollectMetricsFromTarget honors spec.metrics)
  metrics:
    # Per-gateway CPU rate time-series (5m window)
    - name: nginx_cpu_rate
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"ingress-nginx-controller.*",container!="POD",container!=""}[5m]))'
      type: range
      unit: cores
      description: "NGINX Ingress controller CPU rate"
    - name: traefik_cpu_rate
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"traefik.*",container!="POD",container!=""}[5m]))'
      type: range
      unit: cores
      description: "Traefik CPU rate"
    - name: envoy_controller_cpu_rate
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"envoy-gateway.*",container!="POD",container!=""}[5m]))'
      type: range
      unit: cores
      description: "Envoy Gateway control plane CPU rate"
    - name: envoy_dataplane_cpu_rate
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"envoy-default.*|envoy-.*-[a-f0-9]{8,}.*",container!="POD",container!=""}[5m]))'
      type: range
      unit: cores
      description: "Envoy Gateway data-plane proxy CPU rate"
    - name: envoy_total_cpu_rate
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"envoy-gateway.*|envoy-default.*|envoy-.*-[a-f0-9]{8,}.*",container!="POD",container!=""}[5m]))'
      type: range
      unit: cores
      description: "Envoy Gateway total CPU rate (control + data plane)"

    # Per-gateway memory time-series
    - name: nginx_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"ingress-nginx-controller.*",container!="POD",container!=""})'
      type: range
      unit: bytes
      description: "NGINX Ingress controller memory"
    - name: traefik_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"traefik.*",container!="POD",container!=""})'
      type: range
      unit: bytes
      description: "Traefik memory"
    - name: envoy_controller_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"envoy-gateway.*",container!="POD",container!=""})'
      type: range
      unit: bytes
      description: "Envoy Gateway control plane memory"
    - name: envoy_dataplane_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"envoy-default.*|envoy-.*-[a-f0-9]{8,}.*",container!="POD",container!=""})'
      type: range
      unit: bytes
      description: "Envoy Gateway data-plane proxy memory"
    - name: envoy_total_memory
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"envoy-gateway.*|envoy-default.*|envoy-.*-[a-f0-9]{8,}.*",container!="POD",container!=""})'
      type: range
      unit: bytes
      description: "Envoy Gateway total memory (control + data plane)"

    # Per-pod drill-down (excludes system/harness pods)
    - name: cpu_rate_by_pod
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",namespace!~"kube-system|gke-managed-system|gmp-system|gmp-public|observability",pod!~"alloy-.*|ts-vm-hub-.*",container!="POD",container!=""}[5m])) by (pod)'
      type: range
      unit: cores
      description: "CPU rate by pod"
    - name: memory_by_pod
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",namespace!~"kube-system|gke-managed-system|gmp-system|gmp-public|observability",pod!~"alloy-.*|ts-vm-hub-.*",container!="POD",container!=""}) by (pod)'
      type: range
      unit: bytes
      description: "Memory working set by pod"

    # Peak instant queries (max_over_time for summary cards)
    - name: nginx_cpu_peak
      query: 'max_over_time(sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"ingress-nginx-controller.*",container!="POD",container!=""}[5m]))[${DURATION}:])'
      type: instant
      unit: cores
      description: "NGINX Ingress peak CPU"
    - name: traefik_cpu_peak
      query: 'max_over_time(sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"traefik.*",container!="POD",container!=""}[5m]))[${DURATION}:])'
      type: instant
      unit: cores
      description: "Traefik peak CPU"
    - name: envoy_cpu_peak
      query: 'max_over_time(sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",pod=~"envoy-gateway.*|envoy-default.*|envoy-.*-[a-f0-9]{8,}.*",container!="POD",container!=""}[5m]))[${DURATION}:])'
      type: instant
      unit: cores
      description: "Envoy Gateway peak CPU (total)"
    - name: nginx_memory_peak
      query: 'max_over_time(sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"ingress-nginx-controller.*",container!="POD",container!=""})[${DURATION}:])'
      type: instant
      unit: bytes
      description: "NGINX Ingress peak memory"
    - name: traefik_memory_peak
      query: 'max_over_time(sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"traefik.*",container!="POD",container!=""})[${DURATION}:])'
      type: instant
      unit: bytes
      description: "Traefik peak memory"
    - name: envoy_memory_peak
      query: 'max_over_time(sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",pod=~"envoy-gateway.*|envoy-default.*|envoy-.*-[a-f0-9]{8,}.*",container!="POD",container!=""})[${DURATION}:])'
      type: instant
      unit: bytes
      description: "Envoy Gateway peak memory (total)"

    # Cluster totals (range)
    - name: cpu_total
      query: 'sum(rate(container_cpu_usage_seconds_total{experiment="$EXPERIMENT",namespace!~"kube-system|gke-managed-system|gmp-system|gmp-public|observability",pod!~"alloy-.*|ts-vm-hub-.*"}[5m]))'
      type: range
      unit: cores
      description: "Total workload CPU rate"
    - name: memory_total
      query: 'sum(container_memory_working_set_bytes{experiment="$EXPERIMENT",namespace!~"kube-system|gke-managed-system|gmp-system|gmp-public|observability",pod!~"alloy-.*|ts-vm-hub-.*"})'
      type: range
      unit: bytes
      description: "Total workload memory"

  targets:
    - name: app
      cluster:
        type: gke
        machineType: e2-standard-4
        preemptible: true
      observability:
        enabled: true
        transport: tailscale
      components:
        - app: nginx-ingress
        - app: traefik
        - app: envoy-gateway
        - app: nginx
          params:
            replicaCount: "2"
    - name: loadgen
      depends: [app]
      cluster:
        type: gke
        machineType: e2-standard-2
        preemptible: true
      components:
        - app: k6-gateway-loadtest

  workflow:
    template: gateway-comparison-validation
    completion:
      mode: workflow
