# Logging Comparison - Validation + Steady-State Observation Workflow
# Verifies Loki, ELK, and log generator are healthy, then observes for 2h
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: logging-comparison-validation
  namespace: argo-workflows
spec:
  entrypoint: validate-logging-comparison
  serviceAccountName: argo-workflow
  templates:
    - name: validate-logging-comparison
      steps:
        - - name: check-loki
            template: check-deployment
            arguments:
              parameters:
                - name: deployment
                  value: loki
                - name: namespace
                  value: logging-comparison
          - name: check-promtail
            template: check-daemonset
            arguments:
              parameters:
                - name: daemonset
                  value: promtail
                - name: namespace
                  value: logging-comparison
        - - name: check-elasticsearch
            template: check-statefulset
            arguments:
              parameters:
                - name: statefulset
                  value: elasticsearch
                - name: namespace
                  value: logging-comparison
        - - name: check-log-generator
            template: check-deployment
            arguments:
              parameters:
                - name: deployment
                  value: log-generator
                - name: namespace
                  value: logging-comparison
          - name: check-fluent-bit
            template: check-daemonset
            arguments:
              parameters:
                - name: daemonset
                  value: fluent-bit
                - name: namespace
                  value: logging-comparison
        # 2-hour steady-state observation window for metrics collection
        - - name: steady-state-observation
            template: observe

    - name: observe
      container:
        image: busybox:1.36
        command: [sh, -c]
        args:
          - |
            echo "All components healthy. Starting 2h steady-state observation..."
            echo "Log generator rate: 100 lines/sec"
            echo "Metrics will be collected by Prometheus during this window."
            echo "Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            sleep 7200
            echo "End:   $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Observation complete."

    - name: check-deployment
      inputs:
        parameters:
          - name: deployment
          - name: namespace
      container:
        image: bitnami/kubectl:latest
        command: [sh, -c]
        args:
          - |
            echo "Checking deployment {{inputs.parameters.deployment}}..."
            kubectl rollout status deployment/{{inputs.parameters.deployment}} \
              -n {{inputs.parameters.namespace}} --timeout=120s

    - name: check-statefulset
      inputs:
        parameters:
          - name: statefulset
          - name: namespace
      container:
        image: bitnami/kubectl:latest
        command: [sh, -c]
        args:
          - |
            echo "Checking statefulset {{inputs.parameters.statefulset}}..."
            kubectl rollout status statefulset/{{inputs.parameters.statefulset}} \
              -n {{inputs.parameters.namespace}} --timeout=120s

    - name: check-daemonset
      inputs:
        parameters:
          - name: daemonset
          - name: namespace
      container:
        image: bitnami/kubectl:latest
        command: [sh, -c]
        args:
          - |
            echo "Checking daemonset {{inputs.parameters.daemonset}}..."
            kubectl rollout status daemonset/{{inputs.parameters.daemonset}} \
              -n {{inputs.parameters.namespace}} --timeout=120s
