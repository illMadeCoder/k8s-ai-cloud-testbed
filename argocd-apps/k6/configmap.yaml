apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: k6
data:
  baseline.js: |
    // HTTP Baseline Load Test Scenario
    // Simple GET/POST mix to establish baseline metrics

    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate, Trend } from 'k6/metrics';

    // Custom metrics
    const errorRate = new Rate('errors');
    const rootLatency = new Trend('root_latency');
    const healthLatency = new Trend('health_latency');
    const echoLatency = new Trend('echo_latency');

    // Test configuration
    export const options = {
      vus: __ENV.USERS ? parseInt(__ENV.USERS) : 10,
      duration: __ENV.DURATION || '60s',

      thresholds: {
        http_req_duration: ['p(95)<500'],
        errors: ['rate<0.1'],
      },
    };

    const BASE_URL = __ENV.TARGET_URL || 'http://demo-app.demo.svc:80';

    export default function () {
      const rand = Math.random();

      if (rand < 0.7) {
        const res = http.get(`${BASE_URL}/`);
        rootLatency.add(res.timings.duration);
        const success = check(res, {
          'root status 200': (r) => r.status === 200,
        });
        errorRate.add(!success);

      } else if (rand < 0.9) {
        const res = http.get(`${BASE_URL}/health`);
        healthLatency.add(res.timings.duration);
        const success = check(res, {
          'health status 200': (r) => r.status === 200,
        });
        errorRate.add(!success);

      } else {
        const payload = JSON.stringify({
          message: 'baseline test',
          timestamp: new Date().toISOString(),
        });
        const params = {
          headers: { 'Content-Type': 'application/json' },
        };
        const res = http.post(`${BASE_URL}/echo`, payload, params);
        echoLatency.add(res.timings.duration);
        const success = check(res, {
          'echo status 200': (r) => r.status === 200,
        });
        errorRate.add(!success);
      }

      sleep(0.5 + Math.random() * 1.5);
    }
