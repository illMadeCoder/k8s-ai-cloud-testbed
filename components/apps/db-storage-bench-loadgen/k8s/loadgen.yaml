apiVersion: batch/v1
kind: Job
metadata:
  name: db-storage-bench-loadgen
  labels:
    app: db-storage-bench-loadgen
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: db-storage-bench-loadgen
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-dbs
          image: curlimages/curl:8.5.0
          command: [sh, -c]
          args:
            - |
              echo "Waiting for all 8 naive-db variants..."
              VARIANTS="naive-db-fsync-hdd naive-db-nosync-hdd naive-db-fsync-balanced naive-db-nosync-balanced naive-db-fsync-ssd naive-db-nosync-ssd naive-db-fsync-hyperdisk-balanced naive-db-nosync-hyperdisk-balanced"
              for i in $(seq 1 180); do
                all_ready=1
                status=""
                for v in $VARIANTS; do
                  if curl -sf "http://$v/ready" >/dev/null 2>&1; then
                    status="$status $v=OK"
                  else
                    status="$status $v=WAIT"
                    all_ready=0
                  fi
                done
                if [ "$all_ready" -eq 1 ]; then
                  echo "All databases ready"
                  exit 0
                fi
                echo "Attempt $i/180:$status — retrying in 5s..."
                sleep 5
              done
              echo "Databases not ready after 15 minutes"
              exit 1
      containers:
        - name: loadgen
          image: curlimages/curl:8.5.0
          command: [sh, -c]
          args:
            - |
              set -e

              # All 8 variants: {fsync,nosync} × {hdd,balanced,ssd,hyperdisk-balanced}
              FSYNC_HDD="http://naive-db-fsync-hdd"
              NOSYNC_HDD="http://naive-db-nosync-hdd"
              FSYNC_BAL="http://naive-db-fsync-balanced"
              NOSYNC_BAL="http://naive-db-nosync-balanced"
              FSYNC_SSD="http://naive-db-fsync-ssd"
              NOSYNC_SSD="http://naive-db-nosync-ssd"
              FSYNC_HDB="http://naive-db-fsync-hyperdisk-balanced"
              NOSYNC_HDB="http://naive-db-nosync-hyperdisk-balanced"

              ALL_URLS="$FSYNC_HDD $NOSYNC_HDD $FSYNC_BAL $NOSYNC_BAL $FSYNC_SSD $NOSYNC_SSD $FSYNC_HDB $NOSYNC_HDB"
              ALL_NAMES="fsync-hdd nosync-hdd fsync-balanced nosync-balanced fsync-ssd nosync-ssd fsync-hyperdisk-balanced nosync-hyperdisk-balanced"

              # ============================================================
              # Phase 1: Sustained high-throughput writes (60s per variant)
              # Design improvement: sustained load instead of short bursts
              # ============================================================
              echo "=== Phase 1: Sustained high-throughput writes (60s per variant) ==="
              idx=0
              for url in $ALL_URLS; do
                idx=$((idx + 1))
                name=$(echo "$ALL_NAMES" | cut -d' ' -f$idx)
                echo "--- $name: sustained 60s write burst ---"
                end=$(($(date +%s) + 60))
                count=0
                while [ $(date +%s) -lt $end ]; do
                  curl -sf -X POST "$url/write" \
                    -H "Content-Type: application/json" \
                    -d "{\"value\": $count}" >/dev/null
                  count=$((count + 1))
                  if [ $((count % 1000)) -eq 0 ]; then
                    elapsed=$(($(date +%s) - end + 60))
                    rate=0
                    if [ "$elapsed" -gt 0 ]; then rate=$((count / elapsed)); fi
                    echo "$name: $count writes ($rate writes/sec)"
                  fi
                done
                elapsed=$(($(date +%s) - end + 60))
                rate=0
                if [ "$elapsed" -gt 0 ]; then rate=$((count / elapsed)); fi
                echo "$name: sustained burst complete — $count writes in ${elapsed}s ($rate writes/sec)"
              done

              # ============================================================
              # Phase 2: Random point reads (1000 per variant)
              # Verifies read path is independent of sync mode and disk type
              # ============================================================
              echo "=== Phase 2: Random point reads (1000 per variant) ==="
              idx=0
              for url in $ALL_URLS; do
                idx=$((idx + 1))
                name=$(echo "$ALL_NAMES" | cut -d' ' -f$idx)
                echo "--- $name ---"
                i=0
                while [ "$i" -lt 1000 ]; do
                  row_id=$(($(od -An -N2 -tu2 /dev/urandom | tr -d ' ') % 1000))
                  curl -sf "$url/read/$row_id" >/dev/null
                  i=$((i + 1))
                  if [ $((i % 500)) -eq 0 ]; then
                    echo "$name reads: $i / 1000"
                  fi
                done
                echo "$name random reads complete: 1000"
              done

              # ============================================================
              # Phase 3: Mixed OLTP — 70% read / 30% write (1000 ops per variant)
              # ============================================================
              echo "=== Phase 3: Mixed OLTP (70/30 read/write, 1000 ops per variant) ==="
              idx=0
              for url in $ALL_URLS; do
                idx=$((idx + 1))
                name=$(echo "$ALL_NAMES" | cut -d' ' -f$idx)
                echo "--- $name ---"
                i=0
                while [ "$i" -lt 1000 ]; do
                  rnd=$(($(od -An -N1 -tu1 /dev/urandom | tr -d ' ') % 10))
                  if [ "$rnd" -lt 7 ]; then
                    row_id=$(($(od -An -N2 -tu2 /dev/urandom | tr -d ' ') % 1000))
                    curl -sf "$url/read/$row_id" >/dev/null
                  else
                    val=$((50000 + i))
                    curl -sf -X POST "$url/write" \
                      -H "Content-Type: application/json" \
                      -d "{\"value\": $val}" >/dev/null
                  fi
                  i=$((i + 1))
                  if [ $((i % 500)) -eq 0 ]; then
                    echo "$name mixed ops: $i / 1000"
                  fi
                done
                echo "$name mixed OLTP complete: 1000 ops"
              done

              # ============================================================
              # Phase 4: Cooldown (3 min for metrics propagation)
              # ============================================================
              echo "=== Phase 4: Cooldown (3 min) ==="
              sleep 180

              echo "=== Benchmark complete ==="
              echo "--- Final metrics sample ---"
              idx=0
              for url in $ALL_URLS; do
                idx=$((idx + 1))
                name=$(echo "$ALL_NAMES" | cut -d' ' -f$idx)
                echo "--- $name ---"
                curl -sf "$url/metrics" | grep -E "^naivedb_(write_duration|operations_total|rows_total)" | head -10
                echo ""
              done
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 128Mi
